<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MedicBio - Sistema ERP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    
    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #10B981;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .table-container {
      max-height: 400px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      position: sticky;
      top: 0;
      background-color: #F9FAFB;
      z-index: 10;
    }

    .btn-primary {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      transition: all 0.2s;
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background-color: #6B7280;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background-color: #4B5563;
      transform: translateY(-1px);
    }

    .btn-danger {
      background-color: #EF4444;
      transition: all 0.2s;
    }

    .btn-danger:hover {
      background-color: #DC2626;
      transform: translateY(-1px);
    }

    .btn-info {
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      transition: all 0.2s;
    }

    .btn-info:hover:not(:disabled) {
      background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .nav-btn {
      transition: all 0.2s;
    }

    .nav-btn:hover {
      transform: translateX(4px);
    }

    .nav-btn.active {
      background-color: #059669;
    }

    .card {
      transition: all 0.2s;
    }

    .card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .stat-card {
      background: linear-gradient(135deg, var(--color-from) 0%, var(--color-to) 100%);
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
    }

    @media (max-width: 768px) {
      .sidebar-desktop {
        display: none;
      }
      
      .mobile-header {
        display: flex;
      }
    }

    @media (min-width: 769px) {
      .sidebar-desktop {
        display: flex;
      }
      
      .mobile-header {
        display: none;
      }
    }

    .sidebar-mobile {
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
    }

    .sidebar-mobile.open {
      transform: translateX(0);
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    .scroll-container {
      overflow-y: auto;
      height: calc(100% - 80px);
    }

    .form-input {
      transition: all 0.2s;
    }

    .form-input:focus {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
    }

    .tab-gerenciamento {
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
      background: #F3F4F6;
      color: #6B7280;
    }

    .tab-gerenciamento.active {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .tab-gerenciamento:hover:not(.active) {
      background: #E5E7EB;
    }

    .cliente-sugestao {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #E5E7EB;
      transition: all 0.2s;
    }

    .cliente-sugestao:hover {
      background: #F9FAFB;
    }

    .cliente-sugestao:last-child {
      border-bottom: none;
    }

    .produto-card {
      border: 2px solid #E5E7EB;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }

    .produto-card:hover {
      border-color: #10B981;
      background: #ECFDF5;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }

    .carrinho-item {
      border: 2px solid #E5E7EB;
      border-radius: 12px;
      padding: 16px;
      background: white;
      transition: all 0.2s;
    }

    .carrinho-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="w-full h-full">
  
  
  <!-- Mobile Header -->


  
  <header class="mobile-header bg-gradient-to-r from-green-700 to-green-900 text-white p-4 shadow-lg items-center justify-between"><button onclick="toggleMobileSidebar()" class="text-white text-2xl">â˜°</button>
   <h1 class="text-xl font-bold">MedicBio</h1>
   <div class="w-8"></div>
  </header>

  <div class="w-full flex h-full"><!-- Overlay for mobile sidebar -->
   <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="toggleMobileSidebar()"></div><!-- Sidebar Desktop -->
   <aside class="sidebar-desktop w-72 bg-gradient-to-b from-green-700 to-green-900 text-white p-6 flex-col shadow-2xl">
    <div class="mb-10">
     <h1 class="text-3xl font-bold mb-2 tracking-tight">MedicBio</h1>
     <p class="text-green-200 text-sm font-medium">Sistema de GestÃ£o Integrada</p>
    </div>
    <nav class="flex-1 space-y-2"><button onclick="showModule('produtos')" class="nav-btn w-full text-left px-5 py-4 rounded-xl hover:bg-green-600 transition text-base font-medium" id="nav-produtos"> <span>ğŸ“¦ Cadastro de Produtos</span> </button> <button onclick="showModule('clientes')" class="nav-btn w-full text-left px-5 py-4 rounded-xl hover:bg-green-600 transition text-base font-medium" id="nav-clientes"> <span>ğŸ‘¥ Cadastro de Clientes</span> </button> <button onclick="showModule('gerenciamento')" class="nav-btn w-full text-left px-5 py-4 rounded-xl hover:bg-green-600 transition text-base font-medium" id="nav-gerenciamento"> <span>âš™ï¸ Gerenciamento</span> </button> <button onclick="showModule('caixa')" class="nav-btn w-full text-left px-5 py-4 rounded-xl hover:bg-green-600 transition text-base font-medium" id="nav-caixa"> <span>ğŸ’° GestÃ£o de Caixa</span> </button>
     <div class="border-t border-green-600 my-4"></div><button onclick="abrirOpcoesBaixarBackup()" class="nav-btn w-full text-left px-5 py-4 rounded-xl hover:bg-green-600 transition text-base font-medium bg-green-800"> <span>Baixar Backup</span> </button> <button onclick="abrirImportacao()" class="nav-btn w-full text-left px-5 py-4 rounded-xl hover:bg-green-600 transition text-base font-medium bg-green-800"> <span>ğŸ“‚ Importar Backup</span> </button> <button onclick="confirmarLimparDados()" class="nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-red-700 transition text-xs font-medium bg-red-600 opacity-70"> <span>ğŸ—‘ï¸ Limpar Dados</span> </button>
    </nav>
    <footer class="mt-auto pt-6 border-t border-green-600">
     <p class="text-green-200 text-xs">Sistema de GestÃ£o Comercial</p>
     <p class="text-green-300 text-xs mt-2 font-semibold">v2.0 Local - 2025</p>
    </footer>
   </aside><!-- Sidebar Mobile -->
   <aside id="sidebar-mobile" class="sidebar-mobile fixed top-0 left-0 w-72 h-full bg-gradient-to-b from-green-700 to-green-900 text-white p-6 flex flex-col shadow-2xl z-50">
    <div class="flex justify-between items-center mb-10">
     <div>
      <h1 class="text-2xl font-bold tracking-tight">MedicBio</h1>
      <p class="text-green-200 text-xs font-medium">Sistema de GestÃ£o</p>
     </div><button onclick="toggleMobileSidebar()" class="text-white text-2xl">âœ•</button>
    </div>
    <nav class="flex-1 space-y-2"><button onclick="showModule('produtos'); toggleMobileSidebar();" class="nav-btn w-full text-left px-5 py-4 rounded-xl hover:bg-green-600 transition text-base font-medium" id="nav-produtos-mobile"> <span>ğŸ“¦ Cadastro de Produtos</span> </button> <button onclick="showModule('clientes'); toggleMobileSidebar();" class="nav-btn w-full text-left px-5 py-4 rounded-xl hover:bg-green-600 transition text-base font-medium" id="nav-clientes-mobile"> <span>ğŸ‘¥ Cadastro de Clientes</span> </button> <button onclick="showModule('gerenciamento'); toggleMobileSidebar();" class="nav-btn w-full text-left px-5 py-4 rounded-xl hover:bg-green-600 transition text-base font-medium" id="nav-gerenciamento-mobile"> <span>âš™ï¸ Gerenciamento</span> </button> <button onclick="showModule('caixa'); toggleMobileSidebar();" class="nav-btn w-full text-left px-5 py-4 rounded-xl hover:bg-green-600 transition text-base font-medium" id="nav-caixa-mobile"> <span>ğŸ’° GestÃ£o de Caixa</span> </button>
     <div class="border-t border-green-600 my-4"></div><button onclick="abrirOpcoesBaixarBackup(); toggleMobileSidebar();" class="nav-btn w-full text-left px-5 py-4 rounded-xl hover:bg-green-600 transition text-base font-medium bg-green-800"> <span>ğŸ’¾ Baixar Backup</span> </button> <button onclick="abrirImportacao(); toggleMobileSidebar();" class="nav-btn w-full text-left px-5 py-4 rounded-xl hover:bg-green-600 transition text-base font-medium bg-green-800"> <span>ğŸ“‚ Importar Backup</span> </button> <button onclick="confirmarLimparDados(); toggleMobileSidebar();" class="nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-red-700 transition text-xs font-medium bg-red-600 opacity-70"> <span>ğŸ—‘ï¸ Limpar Dados</span> </button>
    </nav>
    <footer class="mt-auto pt-6 border-t border-green-600">
     <p class="text-green-200 text-xs">Sistema de GestÃ£o Comercial</p>
    </footer>
   </aside><!-- Main Content -->
   <main class="flex-1 bg-gray-50 overflow-y-auto scroll-container">
    <div class="p-4 md:p-8 max-w-7xl mx-auto"><!-- MÃ³dulo Produtos -->
     <div id="module-produtos" class="module-content hidden">
      <div class="mb-8">
       <h2 class="text-4xl font-bold text-gray-800 mb-2">Cadastro de Produtos</h2>
       <p class="text-gray-600">Gerencie seu estoque, validade e precificaÃ§Ã£o</p>
      </div><!-- Cards de Status -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
       <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #EF4444; --color-to: #DC2626;">
        <p class="text-red-100 text-sm mb-2 font-semibold">âŒ Produtos em Falta</p>
        <p id="status-sem-estoque" class="text-4xl font-bold">0</p>
       </div>
       <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #F59E0B; --color-to: #D97706;">
        <p class="text-orange-100 text-sm mb-2 font-semibold">âš ï¸ Estoque Baixo</p>
        <p id="status-estoque-baixo" class="text-4xl font-bold">0</p>
       </div>
       <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #10B981; --color-to: #059669;">
        <p class="text-green-100 text-sm mb-2 font-semibold">âœ… Estoque OK</p>
        <p id="status-estoque-ok" class="text-4xl font-bold">0</p>
       </div>
      </div><!-- Form Cadastro Produto -->
      <div class="card bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-8">
       <h3 class="text-2xl font-bold text-gray-800 mb-6">+ Novo Produto</h3>
       <form id="form-produto" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div><label for="produto-nome" class="block text-sm font-semibold text-gray-700 mb-2">Nome do Produto</label> <input type="text" id="produto-nome" required class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
        </div>
        <div><label for="produto-validade" class="block text-sm font-semibold text-gray-700 mb-2">Validade do Produto</label> <input type="date" id="produto-validade" required class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
        </div>
        <div><label for="produto-estoque" class="block text-sm font-semibold text-gray-700 mb-2">Quantidade em Estoque</label> <input type="number" id="produto-estoque" min="0" value="0" required class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
        </div>
        <div><label for="produto-estoque-minimo" class="block text-sm font-semibold text-gray-700 mb-2">Estoque MÃ­nimo</label> <input type="number" id="produto-estoque-minimo" min="0" value="10" required class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
        </div>
        <div><label for="produto-valor-custo" class="block text-sm font-semibold text-gray-700 mb-2">Valor de Custo (R$)</label> <input type="number" id="produto-valor-custo" step="0.01" min="0" required class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
        </div>
        <div><label for="produto-valor-venda" class="block text-sm font-semibold text-gray-700 mb-2">Valor de Venda (R$)</label> <input type="number" id="produto-valor-venda" step="0.01" min="0" required class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
        </div>
        <div class="md:col-span-2"><button type="submit" class="btn-primary text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg"> Cadastrar Produto </button>
        </div>
       </form>
      </div><!-- Lista Produtos -->
      <div class="card bg-white rounded-2xl shadow-lg p-6 md:p-8">
       <h3 class="text-2xl font-bold text-gray-800 mb-6">Produtos Cadastrados</h3><!-- Busca e Filtros -->
       <div class="mb-6 flex flex-col md:flex-row gap-4">
        <div class="flex-1"><input type="text" id="busca-produto" placeholder="ğŸ” Buscar produto..." oninput="renderProdutos()" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
        </div>
        <div class="flex gap-2 flex-wrap"><button onclick="filtrarProdutos('todos')" id="filtro-todos" class="px-4 py-2 rounded-lg font-semibold transition bg-green-600 text-white">Todos</button> <button onclick="filtrarProdutos('positivo')" id="filtro-positivo" class="px-4 py-2 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300">âœ… Estoque Positivo</button> <button onclick="filtrarProdutos('baixo')" id="filtro-baixo" class="px-4 py-2 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300">âš ï¸ Estoque Baixo</button> <button onclick="filtrarProdutos('sem')" id="filtro-sem" class="px-4 py-2 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300">âŒ Sem Estoque</button>
        </div>
       </div>
       <div class="table-container">
        <table class="min-w-full">
         <thead>
          <tr class="border-b-2 border-gray-200">
           <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Produto</th>
           <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Validade</th>
           <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Estoque</th>
           <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">MÃ­nimo</th>
           <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Custo</th>
           <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Venda</th>
           <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Margem</th>
           <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">AÃ§Ãµes</th>
          </tr>
         </thead>
         <tbody id="produtos-list">
          <tr>
           <td colspan="8" class="px-4 py-12 text-center text-gray-500">
            <div class="flex flex-col items-center gap-3"><span class="text-5xl opacity-20">ğŸ“¦</span> <span>Nenhum produto cadastrado</span>
            </div></td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div><!-- MÃ³dulo Clientes -->
     <div id="module-clientes" class="module-content hidden">
      <div class="mb-8">
       <h2 class="text-4xl font-bold text-gray-800 mb-2">ğŸ‘¥ Cadastro de Clientes</h2>
       <p class="text-gray-600">GestÃ£o completa de clientes</p>
      </div><!-- Cards de Status Clientes -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
       <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #3B82F6; --color-to: #2563EB;">
        <p class="text-blue-100 text-sm mb-2 font-semibold"> Total de Clientes</p>
        <p id="status-total-clientes" class="text-4xl font-bold">0</p>
       </div>
       <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #F59E0B; --color-to: #D97706;">
        <p class="text-orange-100 text-sm mb-2 font-semibold">â³ Aguardando</p>
        <p id="status-clientes-aguardando" class="text-4xl font-bold">0</p>
       </div>
       <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #10B981; --color-to: #059669;">
        <p class="text-green-100 text-sm mb-2 font-semibold">âœ… Confirmados</p>
        <p id="status-clientes-confirmados" class="text-4xl font-bold">0</p>
       </div>
       <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #8B5CF6; --color-to: #7C3AED;">
        <p class="text-purple-100 text-sm mb-2 font-semibold">ğŸ‰ Finalizados</p>
        <p id="status-clientes-finalizados" class="text-4xl font-bold">0</p>
       </div>
      </div><!-- Form Cadastro Cliente -->
      <div class="card bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-8">
       <h3 class="text-2xl font-bold text-gray-800 mb-6">+ Novo Cliente</h3>
       <form id="form-cliente" class="space-y-6">
        <div>
         <h4 class="font-bold text-gray-700 mb-4">ğŸ“‹ Dados do Cliente</h4>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div><label for="cliente-data-cadastro" class="block text-sm font-semibold text-gray-700 mb-2">Data do Cadastro</label> <input type="date" id="cliente-data-cadastro" required class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
          </div>
          <div><label for="cliente-nome" class="block text-sm font-semibold text-gray-700 mb-2">Nome Completo</label> <input type="text" id="cliente-nome" required class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
          </div>
          <div><label for="cliente-telefone1" class="block text-sm font-semibold text-gray-700 mb-2">Telefone 1</label> <input type="tel" id="cliente-telefone1" required class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
          </div>
          <div><label for="cliente-telefone2" class="block text-sm font-semibold text-gray-700 mb-2">Telefone 2 (opcional)</label> <input type="tel" id="cliente-telefone2" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
          </div>
         </div>
        </div>
        <div>
         <h4 class="font-bold text-gray-700 mb-4">ğŸ“ EndereÃ§o</h4>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div><label for="cliente-cep" class="block text-sm font-semibold text-gray-700 mb-2">CEP</label> <input type="text" id="cliente-cep" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
          </div>
          <div><label for="cliente-estado" class="block text-sm font-semibold text-gray-700 mb-2">Estado</label> <input type="text" id="cliente-estado" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
          </div>
          <div><label for="cliente-cidade" class="block text-sm font-semibold text-gray-700 mb-2">Cidade</label> <input type="text" id="cliente-cidade" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
          </div>
          <div><label for="cliente-rua" class="block text-sm font-semibold text-gray-700 mb-2">Rua</label> <input type="text" id="cliente-rua" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
          </div>
          <div><label for="cliente-numero" class="block text-sm font-semibold text-gray-700 mb-2">NÃºmero</label> <input type="text" id="cliente-numero" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
          </div>
          <div><label for="cliente-complemento" class="block text-sm font-semibold text-gray-700 mb-2">Complemento</label> <input type="text" id="cliente-complemento" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
          </div>
          <div><label for="cliente-bairro" class="block text-sm font-semibold text-gray-700 mb-2">Bairro</label> <input type="text" id="cliente-bairro" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
          </div>
          <div><label for="cliente-ponto-ref" class="block text-sm font-semibold text-gray-700 mb-2">Ponto de ReferÃªncia</label> <input type="text" id="cliente-ponto-ref" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
          </div>
         </div>
        </div>
        <div><button type="submit" class="btn-primary text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg"> Cadastrar Cliente </button>
        </div>
       </form>
      </div><!-- Lista Clientes -->
      <div class="card bg-white rounded-2xl shadow-lg p-6 md:p-8">
       <h3 class="text-2xl font-bold text-gray-800 mb-6">Clientes Cadastrados</h3><!-- Busca de Cliente -->
       <div class="mb-6"><input type="text" id="busca-cliente" placeholder="ğŸ” Buscar cliente pelo nome..." oninput="renderClientes()" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
       </div>
       <div class="table-container">
        <table class="min-w-full">
         <thead>
          <tr class="border-b-2 border-gray-200">
           <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Data Cadastro</th>
           <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Cliente</th>
           <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Telefone</th>
           <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">ReceituÃ¡rios</th>
           <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">AÃ§Ãµes</th>
          </tr>
         </thead>
         <tbody id="clientes-list">
          <tr>
           <td colspan="5" class="px-4 py-12 text-center text-gray-500">
            <div class="flex flex-col items-center gap-3"><span class="text-5xl opacity-20">ğŸ‘¥</span> <span>Nenhum cliente cadastrado</span>
            </div></td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div><!-- MÃ³dulo Gerenciamento -->
     <div id="module-gerenciamento" class="module-content hidden">
      <div class="mb-8">
       <h2 class="text-4xl font-bold text-gray-800 mb-2">âš™ï¸ Gerenciamento</h2>
       <p class="text-gray-600">Controle de atendimentos e receituÃ¡rios</p>
      </div><!-- Tabs de Gerenciamento -->
      <div class="card bg-white rounded-2xl shadow-lg p-4 mb-6">
       <div class="flex flex-wrap gap-2"><button onclick="mudarAbaGerenciamento('atendimento')" id="tab-atendimento" class="tab-gerenciamento active"> ğŸ”„ Atendimentos </button>
       </div>
      </div><!-- ConteÃºdo Atendimento -->
      <div id="gerenciamento-content-atendimento" class="gerenciamento-content"><!-- Form Novo Atendimento -->
       <div class="card bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-8">
        <h3 class="text-2xl font-bold text-gray-800 mb-6">+ Novo Atendimento</h3>
        <form id="form-atendimento" class="grid grid-cols-1 md:grid-cols-2 gap-6">
         <div><label for="atend-data" class="block text-sm font-semibold text-gray-700 mb-2">Data do Recebimento</label> <input type="date" id="atend-data" required class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
         </div>
         <div><label for="atend-horario" class="block text-sm font-semibold text-gray-700 mb-2">HorÃ¡rio da Mensagem</label> <input type="time" id="atend-horario" required class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
         </div>
         <div><label for="atend-origem" class="block text-sm font-semibold text-gray-700 mb-2">Origem do ReceituÃ¡rio</label> <input type="text" id="atend-origem" placeholder="Ex: WhatsApp, Instagram..." required class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
         </div>
         <div class="relative"><label for="atend-cliente" class="block text-sm font-semibold text-gray-700 mb-2">Buscar Cliente</label> <input type="text" id="atend-cliente" placeholder="Digite o nome do cliente..." oninput="buscarClienteAtendimento()" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none">
          <div id="cliente-sugestoes" class="absolute z-10 w-full bg-white border-2 border-gray-200 rounded-xl mt-1 hidden max-h-48 overflow-y-auto shadow-lg"></div>
         </div>
         <div class="md:col-span-2"><label for="atend-prescricao" class="block text-sm font-semibold text-gray-700 mb-2">PrescriÃ§Ã£o</label> <textarea id="atend-prescricao" rows="4" required class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none"></textarea>
         </div>
         <div class="md:col-span-2"><button type="submit" class="btn-primary text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg"> Registrar Atendimento </button>
         </div>
        </form>
       </div><!-- Status dos Atendimentos -->
       <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
        <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #3B82F6; --color-to: #2563EB;">
         <p class="text-blue-100 text-sm mb-2 font-semibold">ğŸ”„ Em Andamento</p>
         <p id="status-atend-andamento" class="text-4xl font-bold">0</p>
        </div>
        <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #F59E0B; --color-to: #D97706;">
         <p class="text-orange-100 text-sm mb-2 font-semibold">â³ Aguardando</p>
         <p id="status-atend-aguardando" class="text-4xl font-bold">0</p>
        </div>
        <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #10B981; --color-to: #059669;">
         <p class="text-green-100 text-sm mb-2 font-semibold">âœ… Confirmados</p>
         <p id="status-atend-confirmados" class="text-4xl font-bold">0</p>
        </div>
        <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #8B5CF6; --color-to: #7C3AED;">
         <p class="text-purple-100 text-sm mb-2 font-semibold">ğŸ‰ Finalizados</p>
         <p id="status-atend-finalizados" class="text-4xl font-bold">0</p>
        </div>
        <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #EF4444; --color-to: #DC2626;">
         <p class="text-red-100 text-sm mb-2 font-semibold">âŒ NÃ£o Respondidas</p>
         <p id="status-atend-nao-respondidas" class="text-4xl font-bold">0</p>
        </div>
       </div><!-- Lista de Atendimentos -->
       <div class="card bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <h3 class="text-2xl font-bold text-gray-800 mb-6">Todos os Atendimentos</h3><!-- Busca e Filtros -->
        <div class="mb-6">
         <div class="mb-4"><input type="text" id="busca-atendimento" placeholder="ğŸ” Buscar por cliente, origem ou prescriÃ§Ã£o..." oninput="renderAtendimentos()" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
         </div>
         <div class="flex flex-wrap gap-2"><button onclick="filtrarAtendimentos('todos')" id="filtro-atend-todos" class="px-4 py-2 rounded-lg font-semibold transition bg-green-600 text-white">Todos</button> <button onclick="filtrarAtendimentos('aguardando')" id="filtro-atend-aguardando" class="px-4 py-2 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300">â³ Aguardando</button> <button onclick="filtrarAtendimentos('confirmado')" id="filtro-atend-confirmado" class="px-4 py-2 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300">âœ… Confirmado</button> <button onclick="filtrarAtendimentos('finalizado')" id="filtro-atend-finalizado" class="px-4 py-2 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300">ğŸ‰ Finalizado</button> <button onclick="filtrarAtendimentos('nao_respondida')" id="filtro-atend-nao-respondida" class="px-4 py-2 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300">âŒ NÃ£o Respondida</button>
         </div>
        </div>
        <div class="table-container">
         <table class="min-w-full">
          <thead>
           <tr class="border-b-2 border-gray-200">
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Data</th>
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">HorÃ¡rio</th>
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Origem</th>
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Cliente</th>
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Telefone</th>
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Status</th>
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">PrescriÃ§Ã£o</th>
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">AÃ§Ãµes</th>
           </tr>
          </thead>
          <tbody id="atendimentos-list">
           <tr>
            <td colspan="8" class="px-4 py-12 text-center text-gray-500">
             <div class="flex flex-col items-center gap-3"><span class="text-5xl opacity-20">ğŸ”„</span> <span>Nenhum atendimento cadastrado</span>
             </div></td>
           </tr>
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div>
     
     
     <!-- MÃ³dulo Caixa -->
     <div id="module-caixa" class="module-content hidden"><!-- Status Badge do Caixa -->
      <div class="mb-6">
       <div class="card bg-white rounded-2xl shadow-lg p-6 flex flex-col md:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-4">
         <div class="px-6 py-3 rounded-xl font-bold text-lg shadow-lg bg-green-600 text-white">
          ğŸ”“ CAIXA ABERTO
         </div>


         <div class="card bg-white rounded-2xl shadow-lg p-6 mb-6 border-l-4 border-blue-500">
  <div class="flex flex-col md:flex-row items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <div class="bg-blue-100 p-3 rounded-full text-blue-600 font-bold text-xl">ğŸ’°</div>
      <div>
        <p class="text-xs font-bold text-gray-500 uppercase tracking-wide">Valor de Abertura</p>
        <p id="display-valor-inicial" class="text-3xl font-bold text-gray-800">R$ 0,00</p>
      </div>
    </div>

    <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-xl border border-gray-200">
      <div class="flex flex-col">
        <label class="text-[10px] text-gray-500 font-bold uppercase ml-1">Alterar Valor</label>
        <input type="number" id="input-valor-inicial" placeholder="0.00" step="0.01" 
               class="bg-transparent font-bold text-gray-800 outline-none w-32 px-1 text-lg">
      </div>
      <button onclick="salvarValorInicial()" 
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold text-sm shadow-md transition transform hover:scale-105">
        ğŸ’¾ Salvar
      </button>

       <div class="flex gap-3">
            <button onclick="abrirModalSaida()" class="btn-danger text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg flex items-center gap-2"> 
                ğŸ’¸ SAÃDA 
            </button>
            
            <button id="btn-vendas" onclick="abrirPainelVendas()" class="btn-info text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg"> 
                ğŸ›’ VENDAS 
            </button>
        </div>
    </div>
  </div>
</div>


        </div>
       </div>
      </div>

      
      
      <!-- Tabs de Caixa -->
     <div class="flex gap-2">
        <button onclick="abrirModalControleCaixa()" class="bg-gray-800 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-gray-700 transition-colors">
            âš™ï¸ Controle de Caixa
        </button>
        <button onclick="abrirModalHistorico()" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-500 transition-colors">
            ğŸ“‹ HistÃ³rico de Fechamentos
        </button>
            <button onclick="prepararFechamentoManual()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-emerald-500 transition-colors">
        âœ… Registrar DiÃ¡ria
    </button>
    </div>




<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div id="modal-historico" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">ğŸ“‹ HistÃ³rico de Fechamentos</h3>
            <button onclick="fecharModalHistorico()" class="text-gray-400 hover:text-gray-600 text-2xl">âœ•</button>
        </div>

        <div class="mb-8 p-4 bg-gray-50 rounded-xl border border-gray-200">
            <h4 class="text-sm font-bold text-gray-500 mb-4 uppercase tracking-wider">Desempenho Mensal (Saldo Final)</h4>
            <canvas id="graficoMensal" height="100"></canvas>
        </div>


        


    </div>
</div>

















      
      <!-- ConteÃºdo Controle de Caixa -->
      <div id="caixa-content-controle" class="caixa-content"><!-- Controle de NavegaÃ§Ã£o de Data -->
       <div class="card bg-white rounded-2xl shadow-lg p-6 mb-6">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
         <div class="flex flex-col items-center">
          <p class="text-sm font-semibold text-gray-600 mb-2">ğŸ“… Visualizar Data</p>
          <p id="data-selecionada-display" class="text-3xl font-bold text-gray-800">17/01/2026</p>
         </div>
        
         
         <div class="flex items-center gap-3">
            <button onclick="mudarDiaCaixa(-1)" 
                    class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition transform active:scale-95"> 
              â¬…ï¸ Dia Anterior 
            </button> 

            <button onclick="irParaHoje()" 
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition transform active:scale-95"> 
              ğŸ“ Hoje 
            </button> 

            <button onclick="mudarDiaCaixa(1)" 
                    class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition transform active:scale-95"> 
              PrÃ³ximo Dia â¡ï¸ 
            </button>
          </div>



        </div>
       </div>
       
       
       <!-- Cards de Dashboard -->
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
        <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #10B981; --color-to: #059669;">
         <p class="text-green-100 text-sm mb-2 font-semibold">ğŸ’µ Vendas do Dia</p>
         <p id="dash-vendas-dia" class="text-4xl font-bold">R$ 0,00</p>
        </div>
        <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #3B82F6; --color-to: #2563EB;">
         <p class="text-blue-100 text-sm mb-2 font-semibold">ğŸ’° Entradas do Dia</p>
         <p id="dash-entradas-dia" class="text-4xl font-bold">R$ 0,00</p>
        </div>

        <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #EF4444; --color-to: #DC2626;">
         <p class="text-red-100 text-sm mb-2 font-semibold">ğŸ’¸ SaÃ­das do Dia</p>
         <p id="dash-saidas-dia" class="text-4xl font-bold">R$ 0,00</p>
        </div>

        <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #8B5CF6; --color-to: #7C3AED;">
         <p class="text-purple-100 text-sm mb-2 font-semibold">ğŸ’¼ Saldo do Dia</p>
         <p id="dash-caixa-atual" class="text-4xl font-bold">R$ 0,00</p>
        </div>
        <div class="stat-card rounded-2xl shadow-lg p-6 text-white" style="--color-from: #F59E0B; --color-to: #D97706;">
         <p class="text-orange-100 text-sm mb-2 font-semibold">ğŸ“Š Acumulado MÃªs</p>
         <p id="dash-saldo-total" class="text-4xl font-bold">R$ 0,00</p>
        </div>
       </div>
       
        </div>
       
       
        <div id="trans-data" >
       
      
        
        
        <!-- GrÃ¡ficos de AnÃ¡lise -->
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><!-- GrÃ¡fico Formas de Pagamento -->
        <div class="card bg-white rounded-2xl shadow-lg p-6">
         <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š Formas de Pagamento</h3>
         <div class="flex items-center justify-center">
          <canvas id="grafico-formas-pagamento" width="300" height="300"></canvas>
         </div>
         <div id="legenda-formas-pagamento" class="mt-4 space-y-2"></div>
        </div><!-- Ranking Produtos Mais Vendidos -->
        <div class="card bg-white rounded-2xl shadow-lg p-6">
         <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ† Produtos Mais Vendidos</h3>
         <div id="ranking-produtos-vendidos" class="space-y-3"></div>
        </div>
       </div><!-- Lista de TransaÃ§Ãµes -->
       <div class="card bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <h3 class="text-2xl font-bold text-gray-800 mb-6">Todas as TransaÃ§Ãµes</h3><!-- Filtros -->
        <div class="mb-6">
         <div class="flex flex-wrap gap-2 mb-4"><button onclick="filtrarTransacoes('todas')" id="filtro-trans-todas" class="px-4 py-2 rounded-lg font-semibold transition bg-green-600 text-white">Todas</button> <button onclick="filtrarTransacoes('entrada')" id="filtro-trans-entrada" class="px-4 py-2 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300"> Entradas</button> <button onclick="filtrarTransacoes('saida')" id="filtro-trans-saida" class="px-4 py-2 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300">ğŸ’¸ SaÃ­das</button>
         </div>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label class="block text-sm font-semibold text-gray-700 mb-2">Data InÃ­cio</label> <input type="date" id="filtro-data-inicio" onchange="aplicarFiltroDatas()" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
          </div>
          <div><label class="block text-sm font-semibold text-gray-700 mb-2">Data Fim</label> <input type="date" id="filtro-data-fim" onchange="aplicarFiltroDatas()" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
          </div>
          <div class="flex items-end"><button onclick="limparFiltros()" class="btn-secondary text-white px-6 py-3 rounded-xl font-semibold w-full">Limpar Filtros</button>
          </div>
         </div>
        </div>
        <div class="table-container">
         <table class="min-w-full">
          <thead>
           <tr class="border-b-2 border-gray-200">
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Data</th>
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Tipo</th>
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Categoria</th>
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">DescriÃ§Ã£o</th>
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Forma Pagamento</th>
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">Valor</th>
            <th class="px-4 py-4 text-left text-sm font-bold text-gray-700">AÃ§Ãµes</th>
           </tr>
          </thead>
          <tbody id="transacoes-list">
           <tr>
            <td colspan="7" class="px-4 py-12 text-center text-gray-500">
             <div class="flex flex-col items-center gap-3"><span class="text-5xl opacity-20">ğŸ’°</span> <span>Nenhuma transaÃ§Ã£o registrada</span>
             </div></td>
           </tr>
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div>
     
  
     
     
     
     <!-- Modal OpÃ§Ãµes de Backup -->
     <div id="modal-opcoes-backup" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
       <div class="bg-gradient-to-r from-green-700 to-green-900 text-white p-6 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
        <h2 class="text-2xl font-bold">ğŸ’¾ OpÃ§Ãµes de Backup</h2><button onclick="fecharOpcoesBackup()" class="text-white text-3xl hover:text-red-300 transition">âœ•</button>
       </div>
       <div class="p-6 space-y-6"><!-- Backup Completo -->
        <div class="border-2 border-green-200 rounded-xl p-4 bg-green-50">
         <h3 class="font-bold text-gray-800 mb-3 text-lg">ğŸ—‚ï¸ Backup Completo</h3>
         <div class="space-y-2"><button onclick="baixarBackup('todos')" class="w-full btn-primary text-white px-6 py-3 rounded-xl font-bold text-left flex items-center justify-between hover:bg-green-700 transition"> <span>ğŸ“Š Todos os Dados</span> <span class="text-sm opacity-80">Backup completo do sistema</span> </button> <button onclick="baixarBackup('ultimos7dias')" class="w-full btn-info text-white px-6 py-3 rounded-xl font-bold text-left flex items-center justify-between hover:bg-blue-700 transition"> <span>ğŸ“… Ãšltimos 7 Dias</span> <span class="text-sm opacity-80">Dados recentes</span> </button>
         </div>
        </div><!-- Backup por Categoria -->
        <div class="border-2 border-blue-200 rounded-xl p-4 bg-blue-50">
         <h3 class="font-bold text-gray-800 mb-3 text-lg">ğŸ“‚ Backup por Categoria</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-3"><button onclick="baixarBackupCategoria('produtos')" class="bg-white border-2 border-gray-300 hover:border-green-600 text-gray-800 px-4 py-3 rounded-xl font-semibold text-left flex items-center gap-3 transition hover:bg-green-50"> <span class="text-2xl">ğŸ“¦</span> <span>Produtos</span> </button> <button onclick="baixarBackupCategoria('clientes')" class="bg-white border-2 border-gray-300 hover:border-green-600 text-gray-800 px-4 py-3 rounded-xl font-semibold text-left flex items-center gap-3 transition hover:bg-green-50"> <span class="text-2xl">ğŸ‘¥</span> <span>Clientes</span> </button> <button onclick="baixarBackupCategoria('atendimentos')" class="bg-white border-2 border-gray-300 hover:border-green-600 text-gray-800 px-4 py-3 rounded-xl font-semibold text-left flex items-center gap-3 transition hover:bg-green-50"> <span class="text-2xl">ğŸ”„</span> <span>Atendimentos</span> </button> <button onclick="baixarBackupCategoria('transacoes')" class="bg-white border-2 border-gray-300 hover:border-green-600 text-gray-800 px-4 py-3 rounded-xl font-semibold text-left flex items-center gap-3 transition hover:bg-green-50"> <span class="text-2xl">ğŸ’°</span> <span>TransaÃ§Ãµes</span> </button>
         </div>
        </div><!-- PerÃ­odo Personalizado -->
        <div class="border-2 border-purple-200 rounded-xl p-4 bg-purple-50">
         <h3 class="font-bold text-gray-800 mb-3 text-lg">Periodo Personalizado</h3>
         <div class="space-y-3">
          <div><label class="block text-sm font-semibold text-gray-700 mb-1">Data InÃ­cio</label> <input type="date" id="backup-data-inicio" class="form-input w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none text-sm">
          </div>
          <div><label class="block text-sm font-semibold text-gray-700 mb-1">Data Fim</label> <input type="date" id="backup-data-fim" class="form-input w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none text-sm">
          </div><button onclick="baixarBackupPersonalizado()" class="w-full bg-purple-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-purple-700 transition"> ğŸ” Baixar PerÃ­odo Personalizado </button>
         </div>
        </div><button onclick="fecharOpcoesBackup()" class="w-full btn-secondary text-white px-6 py-3 rounded-xl font-semibold"> X </button>
       </div>
      </div>
     </div>
     

</div>
</div>
</div>
</div>











     
     <div id="modal-vendas" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden overflow-y-auto">
  <div class="min-h-screen px-4 py-8">
    <div class="bg-gray-50 rounded-2xl shadow-2xl max-w-7xl mx-auto">
      
      <div class="bg-gradient-to-r from-green-700 to-green-900 text-white p-6 rounded-t-2xl flex justify-between items-center">
        <div class="flex items-center gap-4">
          <button onclick="fecharPainelVendas()" class="text-white text-lg hover:bg-green-800 px-4 py-2 rounded-lg transition font-semibold"> 
            â† Voltar ao Dashboard 
          </button>
          <h2 class="text-3xl font-bold">ğŸ›’ Painel de Vendas</h2>
        </div>
        <button onclick="fecharPainelVendas()" class="text-white text-3xl hover:text-red-300 transition">X</button>
      </div>

      <div id="conteudo-vendas" class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          <div class="lg:col-span-2 space-y-6">
            <div class="card bg-white rounded-2xl shadow-lg p-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ” Buscar Produtos</h3>
              <input type="text" id="busca-produto-venda" placeholder="Digite o nome do produto..." 
                     oninput="buscarProdutosVenda()" 
                     class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
            </div>

            <div class="card bg-white rounded-2xl shadow-lg p-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“¦ Produtos DisponÃ­veis</h3>
              <div id="lista-produtos-venda" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                <div class="col-span-2 text-center text-gray-500 py-8">
                  <span class="text-4xl opacity-20">ğŸ“¦</span>
                  <p class="mt-2">Nenhum produto disponÃ­vel</p>
                </div>
              </div>
            </div>
          </div>

          <div class="lg:col-span-1">
            <div class="card bg-white rounded-2xl shadow-lg p-6 sticky top-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ›’ Carrinho</h3>
              
              <div id="carrinho-items" class="space-y-3 mb-6 max-h-64 overflow-y-auto">
                <div class="text-center text-gray-400 py-8">
                  <span class="text-4xl opacity-20">ğŸ›’</span>
                  <p class="mt-2 text-sm">Carrinho vazio</p>
                </div>
              </div>

              <div class="border-t-2 border-gray-200 pt-4 space-y-3">
                <div class="flex justify-between text-gray-700">
                  <span class="font-semibold">Subtotal:</span> 
                  <span id="carrinho-subtotal" class="font-bold">R$ 0,00</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="font-semibold text-gray-700">Desconto (%):</span> 
                  <input type="number" id="carrinho-desconto" min="0" max="100" value="0" step="1" 
                         oninput="atualizarTotalizador()" 
                         class="w-20 px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none text-center">
                </div>
                <div class="flex justify-between text-xl font-bold text-green-600">
                  <span>TOTAL:</span> 
                  <span id="carrinho-total">R$ 0,00</span>
                </div>
              </div>

              <div class="mt-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Forma de Pagamento</label>
                <select id="forma-pagamento-venda" onchange="verificarPagamentoMisto()" 
                        class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
                  <option value="">Selecione...</option>
                  <option value="dinheiro">ğŸ’µ Dinheiro</option>
                  <option value="pix">ğŸ“± PIX</option>
                  <option value="cartao-debito">ğŸ’³ CartÃ£o de DÃ©bito</option>
                  <option value="cartao-credito">ğŸ’³ CartÃ£o de CrÃ©dito</option>
                  <option value="misto">ğŸ”€ Pagamento Misto (Dividir)</option>
                </select>
              </div>

              <div id="campos-pagamento-misto" class="mt-4 space-y-3 hidden">
                <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                  <p class="text-blue-800 font-semibold text-sm mb-3">ğŸ’¡ Divida o pagamento em atÃ© 3 formas</p>
                  
                  <div class="mb-3">
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Forma 1</label>
                    <div class="grid grid-cols-2 gap-2">
                      <select id="misto-forma1" class="form-input px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none text-sm">
                        <option value="">Selecione...</option>
                        <option value="dinheiro">ğŸ’µ Dinheiro</option>
                        <option value="pix">ğŸ“± PIX</option>
                        <option value="cartao-debito">ğŸ’³ DÃ©bito</option>
                        <option value="cartao-credito">ğŸ’³ CrÃ©dito</option>
                      </select>
                      <input type="number" id="misto-valor1" placeholder="R$ 0,00" step="0.01" min="0" class="form-input px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none text-sm">
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Forma 2</label>
                    <div class="grid grid-cols-2 gap-2">
                      <select id="misto-forma2" class="form-input px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none text-sm">
                        <option value="">Selecione...</option>
                        <option value="dinheiro">ğŸ’µ Dinheiro</option>
                        <option value="pix">ğŸ“± PIX</option>
                        <option value="cartao-debito">ğŸ’³ DÃ©bito</option>
                        <option value="cartao-credito">ğŸ’³ CrÃ©dito</option>
                      </select>
                      <input type="number" id="misto-valor2" placeholder="R$ 0,00" step="0.01" min="0" class="form-input px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none text-sm">
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Forma 3 (opcional)</label>
                    <div class="grid grid-cols-2 gap-2">
                      <select id="misto-forma3" class="form-input px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none text-sm">
                        <option value="">Selecione...</option>
                        <option value="dinheiro">ğŸ’µ Dinheiro</option>
                        <option value="pix">ğŸ“± PIX</option>
                        <option value="cartao-debito">ğŸ’³ DÃ©bito</option>
                        <option value="cartao-credito">ğŸ’³ CrÃ©dito</option>
                      </select>
                      <input type="number" id="misto-valor3" placeholder="R$ 0,00" step="0.01" min="0" class="form-input px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none text-sm">
                    </div>
                  </div>

                  <div class="mt-3 pt-3 border-t border-blue-300">
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-700 font-semibold">Total a Pagar:</span>
                      <span id="misto-total-pagar" class="font-bold text-green-600">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between text-sm mt-1">
                      <span class="text-gray-700 font-semibold">Total Informado:</span>
                      <span id="misto-total-informado" class="font-bold text-blue-600">R$ 0,00</span>
                    </div>
                    <div id="misto-diferenca" class="text-xs mt-2 text-center font-semibold"></div>
                  </div>
                </div>
              </div>

              <div class="mt-6 space-y-3">

                <button id="btn-finalizar-venda" onclick="finalizarVenda()" 
                        class="btn-primary text-white px-6 py-4 rounded-xl font-bold text-lg w-full shadow-lg"> 
                  âœ“ Finalizar Venda 
                </button> 

                <button onclick="limparCarrinho()" 
                        class="btn-secondary text-white px-6 py-3 rounded-xl font-semibold w-full"> 
                  ğŸ—‘ï¸ Limpar Carrinho 
                </button>

              </div>

            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>


</div>
</div>
</div>

</div>
</div>





<div id="modal-saida" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">ğŸ’¸ Registrar SaÃ­da</h3>
            <button onclick="fecharModalSaida()" class="text-gray-400 hover:text-gray-600 text-2xl">âœ•</button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Valor da SaÃ­da (R$)</label>
                <input type="number" id="saida-valor" step="0.01" placeholder="0,00" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 outline-none">
            </div>
            
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">DescriÃ§Ã£o / Motivo</label>
                <input type="text" id="saida-descricao" placeholder="Ex: Pagamento fornecedor, Limpeza..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 outline-none">
            </div>
            
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Categoria</label>
                <select id="saida-categoria" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 outline-none">
                    <option value="Despesas Operacionais">Despesas Operacionais</option>
                    <option value="Fornecedores">Fornecedores</option>
                    <option value="ManutenÃ§Ã£o">ManutenÃ§Ã£o</option>
                    <option value="Retirada">Retirada</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="fecharModalSaida()" class="btn-secondary text-white px-6 py-3 rounded-xl flex-1 font-semibold">Cancelar</button>
                <button onclick="registrarSaida()" class="btn-danger text-white px-6 py-3 rounded-xl flex-1 font-semibold text-lg shadow-lg">Confirmar SaÃ­da</button>
            </div>
        </div>
    </div>
</div>


</div>
</div>










   </main>
  </div><!-- Input file oculto para importaÃ§Ã£o --> <input type="file" id="file-input-backup" accept=".json" style="display: none;" onchange="importarBackup(event)">
  <script>
    // ===== SISTEMA DE ARMAZENAMENTO LOCAL =====
    const STORAGE_KEY = 'medicbio_erp_data';
    let allData = [];
    let nextId = 1;
    
    function carregarDados() {
      try {
        const dados = localStorage.getItem(STORAGE_KEY);
        if (dados) {
          const parsed = JSON.parse(dados);
          allData = parsed.data || [];
          nextId = parsed.nextId || 1;
          console.log('âœ… Dados carregados do localStorage:', allData.length, 'registros');
        }
      } catch (error) {
        console.error('âŒ Erro ao carregar dados:', error);
        allData = [];
        nextId = 1;
      }
    }
    
    function salvarDados() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          data: allData,
          nextId: nextId,
          lastUpdate: new Date().toISOString()
        }));
        console.log('âœ… Dados salvos no localStorage:', allData.length, 'registros');
      } catch (error) {
        console.error(' Erro ao salvar dados:', error);
        showToast('âŒ Erro ao salvar dados', 'error');
      }
    }
    
    function criarRegistro(dados) {
      const novoRegistro = {
        ...dados,
        __backendId: 'ID_' + nextId++,
        __createdAt: new Date().toISOString()
      };
      allData.push(novoRegistro);
      salvarDados();
      atualizarUI();
      return novoRegistro;
    }
    
    function atualizarRegistro(registro) {
      const index = allData.findIndex(item => item.__backendId === registro.__backendId);
      if (index !== -1) {
        allData[index] = {...registro, __updatedAt: new Date().toISOString()};
        salvarDados();
        atualizarUI();
        return true;
      }
      return false;
    }
    
    function deletarRegistro(registro) {
      const index = allData.findIndex(item => item.__backendId === registro.__backendId);
      if (index !== -1) {
        allData.splice(index, 1);
        salvarDados();
        atualizarUI();
        return true;
      }
      return false;
    }
    
    function atualizarUI() {
      renderProdutos();
      atualizarStatusProdutos();
      renderClientes();
      atualizarStatusClientes();
      renderAtendimentos();
      atualizarStatusAtendimentos();
      atualizarDashboardCaixa();
      renderTransacoes();
      renderProdutosVenda();
      renderGraficos();
    }

    function abrirOpcoesBaixarBackup() {
      document.getElementById('modal-opcoes-backup').classList.remove('hidden');
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('backup-data-fim').value = hoje;
    }
    
    function fecharOpcoesBackup() {
      document.getElementById('modal-opcoes-backup').classList.add('hidden');
      document.getElementById('backup-data-inicio').value = '';
      document.getElementById('backup-data-fim').value = '';
    }

    function baixarBackup(periodo) {
      try {
        let dadosFiltrados = [...allData];
        let descricaoPeriodo = 'completo';
        
        if (periodo === 'ultimos7dias') {
          const hoje = new Date();
          const seteDiasAtras = new Date();
          seteDiasAtras.setDate(hoje.getDate() - 7);
          const dataLimite = seteDiasAtras.toISOString().split('T')[0];
          
          dadosFiltrados = allData.filter(item => {
            if (item.data && item.data >= dataLimite) return true;
            if (item.data_cadastro && item.data_cadastro >= dataLimite) return true;
            if (item.__createdAt && item.__createdAt.split('T')[0] >= dataLimite) return true;
            return false;
          });
          
          descricaoPeriodo = 'ultimos_7_dias';
        }
        
        const backupData = {
          versao: '2.0',
          dataExportacao: new Date().toISOString(),
          periodo: descricaoPeriodo,
          totalRegistros: dadosFiltrados.length,
          data: dadosFiltrados,
          nextId: nextId
        };
        
        const dataStr = JSON.stringify(backupData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `medicbio_backup_${descricaoPeriodo}_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        fecharOpcoesBackup();
        showToast('âœ… Backup baixado com sucesso!', 'success');
      } catch (error) {
        console.error('âŒ Erro ao gerar backup:', error);
        showToast('âŒ Erro ao gerar backup', 'error');
      }
    }
    
    function baixarBackupCategoria(categoria) {
      try {
        let dadosFiltrados = [];
        let nomeCategoria = '';
        
        switch(categoria) {
          case 'produtos':
            dadosFiltrados = allData.filter(item => item.tipo === 'produto');
            nomeCategoria = 'produtos';
            break;
          case 'clientes':
            dadosFiltrados = allData.filter(item => item.tipo === 'cliente');
            nomeCategoria = 'clientes';
            break;
          case 'atendimentos':
            dadosFiltrados = allData.filter(item => item.tipo === 'atendimento');
            nomeCategoria = 'atendimentos';
            break;
          case 'transacoes':
            dadosFiltrados = allData.filter(item => item.tipo === 'transacao' || item.tipo === 'valor_inicial');
            nomeCategoria = 'transacoes';
            break;
          default:
            dadosFiltrados = allData;
            nomeCategoria = 'todos';
        }
        
        if (dadosFiltrados.length === 0) {
          showToast(`âš ï¸ Nenhum registro encontrado para ${nomeCategoria}`, 'error');
          return;
        }
        
        const backupData = {
          versao: '2.0',
          dataExportacao: new Date().toISOString(),
          categoria: nomeCategoria,
          totalRegistros: dadosFiltrados.length,
          data: dadosFiltrados,
          nextId: nextId
        };
        
        const dataStr = JSON.stringify(backupData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `medicbio_${nomeCategoria}_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        fecharOpcoesBackup();
        showToast(`âœ… Backup de ${nomeCategoria} baixado! (${dadosFiltrados.length} registros)`, 'success');
      } catch (error) {
        console.error('âŒ Erro ao gerar backup:', error);
        showToast('âŒ Erro ao gerar backup', 'error');
      }
    }
    
    function baixarBackupPersonalizado() {
      const dataInicio = document.getElementById('backup-data-inicio').value;
      const dataFim = document.getElementById('backup-data-fim').value;
      
      if (!dataInicio || !dataFim) {
        showToast('âš ï¸ Selecione as datas de inÃ­cio e fim', 'error');
        return;
      }
      
      if (dataInicio > dataFim) {
        showToast('âš ï¸ Data de inÃ­cio nÃ£o pode ser maior que data fim', 'error');
        return;
      }
      
      try {
        const dadosFiltrados = allData.filter(item => {
          if (item.data && item.data >= dataInicio && item.data <= dataFim) return true;
          if (item.data_cadastro && item.data_cadastro >= dataInicio && item.data_cadastro <= dataFim) return true;
          if (item.__createdAt) {
            const dataCriacao = item.__createdAt.split('T')[0];
            return dataCriacao >= dataInicio && dataCriacao <= dataFim;
          }
          return false;
        });
        
        const backupData = {
          versao: '2.0',
          dataExportacao: new Date().toISOString(),
          periodo: `${dataInicio}_ate_${dataFim}`,
          totalRegistros: dadosFiltrados.length,
          data: dadosFiltrados,
          nextId: nextId
        };
        
        const dataStr = JSON.stringify(backupData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `medicbio_backup_${dataInicio}_ate_${dataFim}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        fecharOpcoesBackup();
        showToast('âœ… Backup personalizado baixado!', 'success');
      } catch (error) {
        console.error('âŒ Erro ao gerar backup:', error);
        showToast('âŒ Erro ao gerar backup', 'error');
      }
    }
    
    function abrirImportacao() {
      document.getElementById('file-input-backup').click();
    }
    
    function importarBackup(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backupData = JSON.parse(e.target.result);

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
          <h3 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“‚ Importar Backup</h3>
          <p class="text-gray-600 mb-2">Total de registros no arquivo: <strong>${backupData.totalRegistros || (backupData.data ? backupData.data.length : 0)}</strong></p>
          <p class="text-gray-600 mb-4">PerÃ­odo: <strong>${backupData.periodo || 'N/A'}</strong></p>
          <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-6">
            <p class="text-blue-800 font-semibold text-sm">â„¹ï¸ Modo de ImportaÃ§Ã£o Inteligente:</p>
            <ul class="text-blue-700 text-xs mt-2 space-y-1 list-disc list-inside">
              <li>Dados novos serÃ£o adicionados</li>
              <li>Dados existentes serÃ£o ignorados</li>
              <li>Seus dados atuais serÃ£o preservados</li>
            </ul>
          </div>
          <div class="flex gap-3">
            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl flex-1 font-semibold transition-colors">X</button>
            <button id="btnConfirmarImportar" class="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-xl flex-1 font-semibold transition-colors">ğŸ“¥ Importar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Listener para o botÃ£o importar (forma mais segura de passar o objeto backupData)
      document.getElementById('btnConfirmarImportar').addEventListener('click', function() {
        confirmarImportacao(backupData);
        modal.remove(); // Fecha a janela ao clicar
      });

    } catch (error) {
      console.error('âŒ Erro ao importar:', error);
      showToast('âŒ Arquivo invÃ¡lido', 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function confirmarImportacao(backupData) {
  try {
    const dadosNovos = backupData.data || [];
    let adicionados = 0;
    let ignorados = 0;

    const idsExistentes = new Set(allData.map(item => item.__backendId));

    dadosNovos.forEach(novoItem => {
      if (!idsExistentes.has(novoItem.__backendId)) {
        allData.push(novoItem);
        adicionados++;

        const idNumerico = parseInt(novoItem.__backendId.replace('ID_', ''));
        if (!isNaN(idNumerico) && idNumerico >= nextId) {
          nextId = idNumerico + 1;
        }
      } else {
        ignorados++;
      }
    });

    salvarDados();
    atualizarUI();

    // NotificaÃ§Ã£o de SUCESSO em VERDE
    showToast(`âœ… ImportaÃ§Ã£o realizada com sucesso! ${adicionados} itens adicionados.`, 'success');

  } catch (error) {
    console.error('âŒ Erro ao importar backu:', error);
    showToast(`âœ… ImportaÃ§Ã£o realizada com sucesso! ${adicionados} itens adicionados.`, 'success');
  }
}
    function confirmarLimparDados() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
          <h3 class="text-2xl font-bold mb-4 text-red-600">âš ï¸ ATENÃ‡ÃƒO - CONFIRMAR EXCLUSÃƒO</h3>
          <p class="text-gray-700 font-semibold mb-4">Esta aÃ§Ã£o irÃ¡ DELETAR permanentemente:</p>
          <ul class="text-gray-600 mb-6 space-y-2 list-disc list-inside">
            <li>Todos os produtos cadastrados</li>
            <li>Todos os clientes cadastrados</li>
            <li>Todos os atendimentos</li>
            <li>Todas as transaÃ§Ãµes de caixa</li>
            <li>Todo o histÃ³rico do sistema</li>
          </ul>
          <p class="text-red-600 font-bold mb-6 text-center">âš ï¸ ESTA AÃ‡ÃƒO NÃƒO PODE SER DESFEITA! âš ï¸</p>
          <div class="flex gap-3">
            <button onclick="this.closest('.fixed').remove()" class="btn-secondary text-white px-6 py-3 rounded-xl flex-1 font-semibold">X</button>
            <button onclick="executarLimparDados()" class="btn-danger text-white px-6 py-3 rounded-xl flex-1 font-semibold"> LIMPAR TUDO</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function executarLimparDados() {
      try {
        allData = [];
        nextId = 1;
        localStorage.removeItem(STORAGE_KEY);
        console.log('âœ… Todos os dados foram apagados');
        
        atualizarUI();
        document.querySelectorAll('.fixed.inset-0').forEach(el => el.remove());
        showToast('âœ… Todos os dados foram limpos com sucesso!', 'success');
      } catch (error) {
        console.error('âŒ Erro ao limpar dados:', error);
        showToast('âŒ Erro ao limpar dados', 'error');
      }
    }

    let filtroTransacaoAtual = 'todas';
    let filtroProdutoAtual = 'todos';
    let filtroAtendimentoAtual = 'todos';
    let clienteSelecionadoAtendimento = null;
    let carrinhoVendas = [];
    let produtoEmEdicao = null;
    let clienteEmEdicao = null;
    let dataSelecionadaCaixa = new Date();
    let vendaEmProcessamento = false;

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-xl shadow-2xl text-white font-semibold text-sm ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Localize esta parte no final do seu arquivo index.html:
function init() {
    carregarDados();
    
    // Forma segura de pegar a data local YYYY-MM-DD
    const agora = new Date();
    const hoje = agora.getFullYear() + '-' + 
                 String(agora.getMonth() + 1).padStart(2, '0') + '-' + 
                 String(agora.getDate()).padStart(2, '0');

    document.getElementById('produto-validade').value = hoje;
    document.getElementById('cliente-data-cadastro').value = hoje;
    document.getElementById('atend-data').value = hoje;
    document.getElementById('trans-data').value = hoje;
    
    dataSelecionadaCaixa = new Date();
    atualizarDisplayData();
    showModule('produtos');
    atualizarUI();
}

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    function toggleMobileSidebar() {
      const sidebar = document.getElementById('sidebar-mobile');
      const overlay = document.getElementById('sidebar-overlay');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('hidden');
    }

    function showModule(module) {
    document.querySelectorAll('.module-content').forEach(el => el.classList.add('hidden'));
    document.getElementById(`module-${module}`)?.classList.remove('hidden');
    
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`nav-${module}`)?.classList.add('active');
    document.getElementById(`nav-${module}-mobile`)?.classList.add('active');

    // NOVA CORREÃ‡ÃƒO: Se abrir o caixa, renderiza o grÃ¡fico
    if (module === 'caixa') {
        setTimeout(() => { // O timeout garante que o elemento jÃ¡ saiu do 'hidden'
            if (typeof renderGraficoMensal === 'function') {
                renderGraficoMensal();
            }
        }, 100);
    }
}

    function abrirPainelVendas() {
      document.getElementById('modal-vendas').classList.remove('hidden');
      document.getElementById('busca-produto-venda').value = '';
      renderProdutosVenda();
      renderCarrinho();
    }
    
    function fecharPainelVendas() { 
      document.getElementById('modal-vendas').classList.add('hidden'); 
    }
    
    function buscarProdutosVenda() {
      renderProdutosVenda();
    }
    
    function renderProdutosVenda() {
      let produtos = allData.filter(item => item.tipo === 'produto' && item.estoque > 0);
      const busca = document.getElementById('busca-produto-venda').value.toLowerCase();
      
      if (busca) {
        produtos = produtos.filter(p => p.nome.toLowerCase().includes(busca));
      }
      
      const container = document.getElementById('lista-produtos-venda');
      
      if (produtos.length === 0) {
        container.innerHTML = `
          <div class="col-span-2 text-center text-gray-500 py-8">
            <span class="text-4xl opacity-20">ğŸ“¦</span>
            <p class="mt-2">Nenhum produto disponÃ­vel</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = produtos.map(produto => `
        <div class="produto-card">
          <div class="flex flex-col gap-2">
            <h4 class="font-bold text-gray-800 text-sm">${produto.nome}</h4>
            <div class="flex justify-between items-center text-xs text-gray-600">
              <span>Estoque: <strong>${produto.estoque}</strong></span>
              <span class="text-green-600 font-bold text-base">R$ ${produto.valor_venda.toFixed(2)}</span>
            </div>
            <button onclick="adicionarAoCarrinho('${produto.__backendId}')" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold text-sm mt-2">
              + Adicionar
            </button>
          </div>
        </div>
      `).join('');
    }
    
    function adicionarAoCarrinho(produtoId) {
      const produto = allData.find(p => p.__backendId === produtoId);
      if (!produto) return;
      
      const itemExistente = carrinhoVendas.find(item => item.produto_id === produtoId);
      
      if (itemExistente) {
        if (itemExistente.quantidade >= produto.estoque) {
          showToast('âš ï¸ Estoque insuficiente', 'error');
          return;
        }
        itemExistente.quantidade++;
      } else {
        carrinhoVendas.push({
          produto_id: produtoId,
          nome: produto.nome,
          valor_unitario: produto.valor_venda,
          quantidade: 1,
          estoque_disponivel: produto.estoque
        });
      }
      
      renderCarrinho();
      atualizarTotalizador();
      showToast('âœ… Produto adicionado', 'success');
    }
    
    function renderCarrinho() {
      const container = document.getElementById('carrinho-items');
      
      if (carrinhoVendas.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <span class="text-4xl opacity-20">ğŸ›’</span>
            <p class="mt-2 text-sm">Carrinho vazio</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = carrinhoVendas.map((item, index) => `
        <div class="carrinho-item">
          <div class="flex justify-between items-start mb-2">
            <h5 class="font-semibold text-gray-800 text-sm flex-1">${item.nome}</h5>
            <button onclick="removerDoCarrinho(${index})" class="text-red-600 hover:text-red-800 ml-2">ğŸ—‘ï¸</button>
          </div>
          <div class="flex justify-between items-center text-xs text-gray-600">
            <span>R$ ${item.valor_unitario.toFixed(2)}</span>
            <div class="flex items-center gap-2">
              <button onclick="alterarQuantidade(${index}, -1)" class="bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded font-bold">-</button>
              <span class="font-bold text-gray-800">${item.quantidade}</span>
              <button onclick="alterarQuantidade(${index}, 1)" class="bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded font-bold">+</button>
            </div>
          </div>
          <div class="text-right mt-2">
            <span class="text-green-600 font-bold text-sm">R$ ${(item.valor_unitario * item.quantidade).toFixed(2)}</span>
          </div>
        </div>
      `).join('');
    }
    
    function removerDoCarrinho(index) {
      carrinhoVendas.splice(index, 1);
      renderCarrinho();
      atualizarTotalizador();
      showToast('âœ… Item removido', 'success');
    }
    
    function alterarQuantidade(index, delta) {
      const item = carrinhoVendas[index];
      const novaQuantidade = item.quantidade + delta;
      
      if (novaQuantidade <= 0) {
        removerDoCarrinho(index);
        return;
      }
      
      if (novaQuantidade > item.estoque_disponivel) {
        showToast('âš ï¸ Estoque insuficiente', 'error');
        return;
      }
      
      item.quantidade = novaQuantidade;
      renderCarrinho();
      atualizarTotalizador();
    }
    
    function atualizarTotalizador() {
      const subtotal = carrinhoVendas.reduce((total, item) => total + (item.valor_unitario * item.quantidade), 0);
      const desconto = parseFloat(document.getElementById('carrinho-desconto').value) || 0;
      const valorDesconto = subtotal * (desconto / 100);
      const total = subtotal - valorDesconto;
      
      document.getElementById('carrinho-subtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
      document.getElementById('carrinho-total').textContent = `R$ ${total.toFixed(2)}`;
      
      // Atualizar total no pagamento misto se estiver visÃ­vel
      if (!document.getElementById('campos-pagamento-misto').classList.contains('hidden')) {
        document.getElementById('misto-total-pagar').textContent = `R$ ${total.toFixed(2)}`;
        calcularTotalMisto();
      }
    }
    
    function verificarPagamentoMisto() {
      const formaPagamento = document.getElementById('forma-pagamento-venda').value;
      const camposMisto = document.getElementById('campos-pagamento-misto');
      
      if (formaPagamento === 'misto') {
        camposMisto.classList.remove('hidden');
        
        // Calcular total atual
        const subtotal = carrinhoVendas.reduce((total, item) => total + (item.valor_unitario * item.quantidade), 0);
        const desconto = parseFloat(document.getElementById('carrinho-desconto').value) || 0;
        const valorDesconto = subtotal * (desconto / 100);
        const total = subtotal - valorDesconto;
        
        document.getElementById('misto-total-pagar').textContent = `R$ ${total.toFixed(2)}`;
        
        // Adicionar eventos aos campos de valor
        document.getElementById('misto-valor1').addEventListener('input', calcularTotalMisto);
        document.getElementById('misto-valor2').addEventListener('input', calcularTotalMisto);
        document.getElementById('misto-valor3').addEventListener('input', calcularTotalMisto);
      } else {
        camposMisto.classList.add('hidden');
        // Limpar campos
        document.getElementById('misto-forma1').value = '';
        document.getElementById('misto-forma2').value = '';
        document.getElementById('misto-forma3').value = '';
        document.getElementById('misto-valor1').value = '';
        document.getElementById('misto-valor2').value = '';
        document.getElementById('misto-valor3').value = '';
      }
    }
    















   // FunÃ§Ã£o para calcular em tempo real se a soma bate com o total
function calcularTotalMisto() {
    const valor1 = parseFloat(document.getElementById('misto-valor1').value) || 0;
    const valor2 = parseFloat(document.getElementById('misto-valor2').value) || 0;
    const valor3 = parseFloat(document.getElementById('misto-valor3').value) || 0;

    const totalInformado = valor1 + valor2 + valor3;

    // Pegar o total a pagar do carrinho (Calculando com desconto)
    const subtotal = carrinhoVendas.reduce((total, item) => total + (item.valor_unitario * item.quantidade), 0);
    const desconto = parseFloat(document.getElementById('carrinho-desconto').value) || 0;
    const valorDesconto = subtotal * (desconto / 100);
    const totalPagar = subtotal - valorDesconto;

    document.getElementById('misto-total-informado').textContent = `R$ ${totalInformado.toFixed(2)}`;

    const diferenca = totalInformado - totalPagar;
    const diferencaEl = document.getElementById('misto-diferenca');

    // Margem de erro pequena para arredondamentos float
    if (Math.abs(diferenca) < 0.05) {
        diferencaEl.textContent = 'âœ… Valores conferem!';
        diferencaEl.className = 'text-xs mt-2 text-center font-bold text-green-600 bg-green-100 p-1 rounded';
    } else if (diferenca > 0) {
        diferencaEl.textContent = `âš ï¸ Passou: R$ ${diferenca.toFixed(2)}`;
        diferencaEl.className = 'text-xs mt-2 text-center font-bold text-orange-600 bg-orange-100 p-1 rounded';
    } else {
        diferencaEl.textContent = `âš ï¸ Falta: R$ ${Math.abs(diferenca).toFixed(2)}`;
        diferencaEl.className = 'text-xs mt-2 text-center font-bold text-red-600 bg-red-100 p-1 rounded';
    }
}

// FunÃ§Ã£o Atualizada de Finalizar Venda
function finalizarVenda() {
    if (vendaEmProcessamento) return;

    if (carrinhoVendas.length === 0) {
        showToast('âš ï¸ Carrinho vazio', 'error');
        return;
    }

    const formaPagamento = document.getElementById('forma-pagamento-venda').value;
    if (!formaPagamento) {
        showToast('âš ï¸ Selecione forma de pagamento', 'error');
        return;
    }

    // CÃ¡lculos de totais
    const subtotal = carrinhoVendas.reduce((total, item) => total + (item.valor_unitario * item.quantidade), 0);
    const desconto = parseFloat(document.getElementById('carrinho-desconto').value) || 0;
    const valorDesconto = subtotal * (desconto / 100);
    const total = subtotal - valorDesconto;

    let descricaoFormaPagamento = '';
    let detalhesPagamentoMisto = []; // Para salvar no banco de dados

    // LÃ³gica EspecÃ­fica do Misto
    if (formaPagamento === 'misto') {
        const valor1 = parseFloat(document.getElementById('misto-valor1').value) || 0;
        const valor2 = parseFloat(document.getElementById('misto-valor2').value) || 0;
        const valor3 = parseFloat(document.getElementById('misto-valor3').value) || 0;
        
        const forma1 = document.getElementById('misto-forma1').value;
        const forma2 = document.getElementById('misto-forma2').value;
        const forma3 = document.getElementById('misto-forma3').value;

        const totalInformado = valor1 + valor2 + valor3;

        // ValidaÃ§Ã£o RÃ­gida
        if (Math.abs(totalInformado - total) > 0.05) {
            showToast('âš ï¸ A soma dos valores nÃ£o confere com o total!', 'error');
            return;
        }

        const labels = {
            'dinheiro': 'Dinheiro', 'pix': 'PIX', 
            'cartao-debito': 'DÃ©bito', 'cartao-credito': 'CrÃ©dito'
        };

        // Monta Array e Texto
        if (valor1 > 0 && forma1) {
            detalhesPagamentoMisto.push({ forma: forma1, valor: valor1 });
            descricaoFormaPagamento += `${labels[forma1]}: R$ ${valor1.toFixed(2)}`;
        }
        if (valor2 > 0 && forma2) {
            detalhesPagamentoMisto.push({ forma: forma2, valor: valor2 });
            descricaoFormaPagamento += ` | ${labels[forma2]}: R$ ${valor2.toFixed(2)}`;
        }
        if (valor3 > 0 && forma3) {
            detalhesPagamentoMisto.push({ forma: forma3, valor: valor3 });
            descricaoFormaPagamento += ` | ${labels[forma3]}: R$ ${valor3.toFixed(2)}`;
        }

    } else {
        // Pagamento Simples
        const labels = {
            'dinheiro': 'Dinheiro', 'pix': 'PIX', 
            'cartao-debito': 'DÃ©bito', 'cartao-credito': 'CrÃ©dito'
        };
        descricaoFormaPagamento = labels[formaPagamento] || formaPagamento;
    }

    // Objeto para o PDF e Processamento
    const dadosVenda = {
        data: dataSelecionadaCaixa.toISOString().split('T')[0],
        itens: carrinhoVendas.map(item => ({
            nome: item.nome,
            quantidade: item.quantidade,
            valor_unitario: item.valor_unitario
        })),
        subtotal: subtotal,
        desconto: desconto,
        valorDesconto: valorDesconto,
        total: total,
        formaPagamentoCode: formaPagamento, // misto, dinheiro, etc
        formaPagamentoTexto: descricaoFormaPagamento, // Texto formatado
        detalhesMisto: detalhesPagamentoMisto // Array com os detalhes
    };

    // Modal de ConfirmaÃ§Ã£o
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
          <h3 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“„ Finalizar Venda</h3>
          <p class="text-gray-600 mb-2">Total: <strong>R$ ${total.toFixed(2)}</strong></p>
          <p class="text-sm text-gray-500 mb-6">Pagamento: ${descricaoFormaPagamento}</p>
          
          <div class="flex gap-3 flex-col">
            <button onclick="processarVendaComPDF(${JSON.stringify(dadosVenda).replace(/"/g, '&quot;')})" class="btn-primary text-white px-6 py-3 rounded-xl font-bold">âœ“ Gerar Recibo e Finalizar</button>
            <button onclick="processarVendaSemPDF(${JSON.stringify(dadosVenda).replace(/"/g, '&quot;')})" class="btn-secondary text-white px-6 py-3 rounded-xl font-semibold">Apenas Finalizar (Sem Recibo)</button>
            <button onclick="this.closest('.fixed').remove()" class="text-red-500 font-semibold mt-2">Cancelar</button>
          </div>
        </div>
      `;
    document.body.appendChild(modal);
}








async function gerarReciboPDF(dadosVenda) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: "p",
    unit: "mm",
    format: "a4"
  });

  // ===== CABEÃ‡ALHO PROFISSIONAL COM BORDA =====
  doc.setFillColor(16, 185, 129);
  doc.rect(0, 0, 210, 45, 'F');
  
  doc.setFontSize(28);
  doc.setTextColor(255, 255, 255);
  doc.setFont(undefined, 'bold');
  doc.text("MEDICBIO", 105, 20, { align: "center" });
  
  doc.setFontSize(8);
  doc.text("R. Dr. JoÃ£o TomÃ©, 780 - Camocim, CE, 62400-000", 105, 34, { align: "center" });
  doc.text("Telefone: (86) 99901-8464", 105, 39, { align: "center" });

  // ===== TÃTULO DO RECIBO =====
  doc.setFontSize(16);
  doc.setTextColor(16, 185, 129);
  doc.setFont(undefined, 'bold');
  doc.text("RECIBO DE VENDA", 105, 58, { align: "center" });
  
  doc.setDrawColor(16, 185, 129);
  doc.setLineWidth(0.5);
  doc.line(60, 60, 150, 60);

  // ===== INFORMAÃ‡Ã•ES DA VENDA =====
  doc.setFontSize(10);
  doc.setTextColor(0, 0, 0);
  doc.setFont(undefined, 'normal');
  
  doc.setDrawColor(200, 200, 200);
  doc.setLineWidth(0.3);
  doc.roundedRect(15, 68, 180, 18, 3, 3, 'S');
  
  doc.setFont(undefined, 'bold');
  doc.text("Data:", 20, 76);
  doc.text("Hora:", 20, 82);
  doc.text("NÂº Recibo:", 110, 76);
  
  doc.setFont(undefined, 'normal');
  doc.text(new Date(dadosVenda.data).toLocaleDateString('pt-BR'), 35, 76);
  doc.text(new Date().toLocaleTimeString('pt-BR'), 35, 82);
  const numeroRecibo = Math.floor(Math.random() * 100000).toString().padStart(6, '0');
  doc.text(`#${numeroRecibo}`, 135, 76);

  // ===== TABELA DE PRODUTOS =====
  let y = 100;
  doc.setFillColor(240, 240, 240);
  doc.rect(15, y - 6, 180, 8, 'F');
  
  doc.setFontSize(9);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(60, 60, 60);
  doc.text("PRODUTO", 18, y);
  doc.text("QTD", 140, y, { align: "center" });
  doc.text("UNI.", 160, y, { align: "center" });
  doc.text("SUBTOTAL", 192, y, { align: "right" });
  
  doc.setDrawColor(200, 200, 200);
  doc.line(15, y + 2, 195, y + 2);
  
  y += 10;
  doc.setFont(undefined, 'normal');
  doc.setFontSize(9);
  doc.setTextColor(0, 0, 0);
  
  dadosVenda.itens.forEach((item, index) => {
    if (index % 2 === 0) {
      doc.setFillColor(250, 250, 250);
      doc.rect(15, y - 5, 180, 7, 'F');
    }
    const nomeTruncado = item.nome.length > 45 ? item.nome.substring(0, 42) + '...' : item.nome;
    doc.text(nomeTruncado, 18, y);
    doc.text(item.quantidade.toString(), 140, y, { align: "center" });
    doc.text(`R$ ${item.valor_unitario.toFixed(2)}`, 160, y, { align: "center" });
    doc.text(`R$ ${(item.valor_unitario * item.quantidade).toFixed(2)}`, 192, y, { align: "right" });
    y += 7;
  });
  
  y += 3;
  doc.setDrawColor(16, 185, 129);
  doc.setLineWidth(0.5);
  doc.line(15, y, 195, y);

  // ===== BLOCO DE TOTAIS (FORMA DE PAGAMENTO REMOVIDA) =====
  y += 10;
  const yInicialBloco = y; 

  // Esquerda: Se for misto, mostra apenas os itens. Se nÃ£o, nÃ£o mostra nada.
  if (dadosVenda.formaPagamentoCode === 'misto' && dadosVenda.detalhesMisto) {
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    dadosVenda.detalhesMisto.forEach(pag => {
      const labels = {'dinheiro': 'Dinheiro', 'pix': 'PIX', 'cartao-debito': 'DÃ©bito', 'cartao-credito': 'CrÃ©dito'};
      doc.text(`â€¢ ${labels[pag.forma] || pag.forma}: R$ ${pag.valor.toFixed(2)}`, 15, y);
      y += 5;
    });
  }

  // Direita: Box de Totais (Limpo e sem caracteres estranhos)
  doc.setFillColor(248, 250, 252);
  doc.setDrawColor(200, 200, 200);
  doc.setLineWidth(0.3);
  const alturaBox = (dadosVenda.desconto > 0 ? 24 : 17);
  doc.roundedRect(120, yInicialBloco - 6, 75, alturaBox, 2, 2, 'FD');
  
  let yTxt = yInicialBloco;
  doc.setFontSize(10);
  doc.setTextColor(80, 80, 80);
  doc.setFont(undefined, 'normal');
  doc.text("Subtotal:", 125, yTxt);
  doc.text(`R$ ${dadosVenda.subtotal.toFixed(2)}`, 190, yTxt, { align: "right" });
  
  if (dadosVenda.desconto > 0) {
    yTxt += 7;
    doc.setTextColor(220, 38, 38);
    doc.text(`Desconto (${dadosVenda.desconto}%):`, 125, yTxt);
    doc.text(`- R$ ${dadosVenda.valorDesconto.toFixed(2)}`, 190, yTxt, { align: "right" });
  }
  
  yTxt += 7;
  doc.setFont(undefined, 'bold');
  doc.setFontSize(14);
  doc.setTextColor(16, 185, 129);
  doc.text("TOTAL:", 125, yTxt);
  doc.text(`R$ ${dadosVenda.total.toFixed(2)}`, 190, yTxt, { align: "right" });

  // ===== QR CODES E RODAPÃ‰ (IGUAL AO ORIGINAL) =====
  y = 240; 
  doc.setDrawColor(200, 200, 200);
  doc.line(15, y, 195, y);
  
  y += 8;
  const qrInstagram = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent('https://www.instagram.com/medicbio26/')}`;
  try {
    doc.addImage(qrInstagram, 'PNG', 25, y, 25, 25);
    doc.setFontSize(8); doc.setFont(undefined, 'bold'); doc.setTextColor(0,0,0);
    doc.text("Siga no Instagram", 37.5, y + 28, { align: "center" });
    doc.setFont(undefined, 'normal'); doc.setFontSize(7);
    doc.text("@medicbio26", 37.5, y + 32, { align: "center" });
  } catch (e) {}
  
  const qrGoogle = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent('https://share.google/4lursoq1a8tHt3kKC')}`;
  try {
    doc.addImage(qrGoogle, 'PNG', 160, y, 25, 25);
    doc.setFontSize(8); doc.setFont(undefined, 'bold');
    doc.text("Avalie no Google", 172.5, y + 28, { align: "center" });
    doc.setFont(undefined, 'normal'); doc.setFontSize(7);
    doc.text("Sua opiniÃ£o Ã© importante!", 172.5, y + 32, { align: "center" });
  } catch (e) {}
  
  doc.setFontSize(10); doc.setFont(undefined, 'bold'); doc.setTextColor(16, 185, 129);
  doc.text("Obrigado pela preferÃªncia!", 105, y + 10, { align: "center" });
  doc.setFontSize(8); doc.setFont(undefined, 'normal'); doc.setTextColor(100, 100, 100);
  doc.text("HorÃ¡rio de funcionamento: Segunda a SÃ¡bado - 08:00 Ã s 18:00", 105, y + 16, { align: "center" });

  doc.save(`medicbio_recibo_${numeroRecibo}.pdf`);
}










    
    function finalizarVenda() {
      if (vendaEmProcessamento) {
        showToast('â³ Aguarde...', 'error');
        return;
      }
      
      if (carrinhoVendas.length === 0) {
        showToast('âš ï¸ Carrinho vazio', 'error');
        return;
      }

      
      const formaPagamento = document.getElementById('forma-pagamento-venda').value;
      if (!formaPagamento) {
        showToast('âš ï¸ Selecione forma de pagamento', 'error');
        return;
      }

      
      // Validar pagamento misto
      if (formaPagamento === 'misto') {
        const forma1 = document.getElementById('misto-forma1').value;
        const forma2 = document.getElementById('misto-forma2').value;
        const valor1 = parseFloat(document.getElementById('misto-valor1').value) || 0;
        const valor2 = parseFloat(document.getElementById('misto-valor2').value) || 0;
        
        if (!forma1 || !forma2) {
          showToast('âš ï¸ Preencha pelo menos 2 formas de pagamento', 'error');
          return;
        }
        
        if (valor1 <= 0 || valor2 <= 0) {
          showToast('âš ï¸ Valores devem ser maiores que zero', 'error');
          return;
        }
        
        // Verificar se os valores conferem
        const subtotal = carrinhoVendas.reduce((total, item) => total + (item.valor_unitario * item.quantidade), 0);
        const desconto = parseFloat(document.getElementById('carrinho-desconto').value) || 0;
        const valorDesconto = subtotal * (desconto / 100);
        const totalPagar = subtotal - valorDesconto;
        
        const valor3 = parseFloat(document.getElementById('misto-valor3').value) || 0;
        const totalInformado = valor1 + valor2 + valor3;
        const diferenca = Math.abs(totalInformado - totalPagar);
        
        if (diferenca > 0.01) {
          showToast('âš ï¸ Os valores nÃ£o conferem com o total', 'error');
          return;
        }
      }
      
      // Calcular dados da venda
      const subtotal = carrinhoVendas.reduce((total, item) => total + (item.valor_unitario * item.quantidade), 0);
      const desconto = parseFloat(document.getElementById('carrinho-desconto').value) || 0;
      const valorDesconto = subtotal * (desconto / 100);
      const total = subtotal - valorDesconto;
      

      // Criar descriÃ§Ã£o da forma de pagamento
      let descricaoFormaPagamento = '';
      let formasPagamentoArray = [];
      
      const labelsFormas = {
        'dinheiro': 'ğŸ’µ Dinheiro',
        'pix': 'ğŸ“± PIX',
        'cartao-debito': 'ğŸ’³ CartÃ£o de DÃ©bito',
        'cartao-credito': 'ğŸ’³ CartÃ£o de CrÃ©dito',
        'transferencia': 'ğŸ¦ TransferÃªncia',
        'boleto': 'ğŸ“„ Boleto'
      };






      

      
      if (formaPagamento === 'misto') {
        const forma1 = document.getElementById('misto-forma1').value;
        const forma2 = document.getElementById('misto-forma2').value;
        const forma3 = document.getElementById('misto-forma3').value;
        const valor1 = parseFloat(document.getElementById('misto-valor1').value) || 0;
        const valor2 = parseFloat(document.getElementById('misto-valor2').value) || 0;
        const valor3 = parseFloat(document.getElementById('misto-valor3').value) || 0;
        
        formasPagamentoArray.push({ forma: forma1, valor: valor1 });
        formasPagamentoArray.push({ forma: forma2, valor: valor2 });
        if (forma3 && valor3 > 0) {
          formasPagamentoArray.push({ forma: forma3, valor: valor3 });
        }
        
        descricaoFormaPagamento = formasPagamentoArray
          .map(fp => `${labelsFormas[fp.forma] || fp.forma}: R$ ${fp.valor.toFixed(2)}`)
          .join(' + ');
      } else {
        descricaoFormaPagamento = labelsFormas[formaPagamento] || formaPagamento;
      }
      
      // Preparar dados para o PDF
      const dadosVenda = {
        data: dataSelecionadaCaixa.toISOString().split('T')[0],
        itens: carrinhoVendas.map(item => ({
          nome: item.nome,
          quantidade: item.quantidade,
          valor_unitario: item.valor_unitario
        })),
        subtotal: subtotal,
        desconto: desconto,
        valorDesconto: valorDesconto,
        total: total,
        formaPagamentoTexto: descricaoFormaPagamento
      };
      
      // Perguntar se deseja gerar PDF
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
          <h3 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“„ Gerar Recibo em PDF?</h3>
          <p class="text-gray-600 mb-6">Deseja baixar o recibo desta venda em PDF?</p>
          <div class="flex gap-3">
            
            <button onclick="processarVendaSemPDF(${JSON.stringify(dadosVenda).replace(/"/g, '&quot;')})" class="btn-secondary text-white px-6 py-3 rounded-xl flex-1 font-semibold">NÃ£o</button>
            <button onclick="processarVendaComPDF(${JSON.stringify(dadosVenda).replace(/"/g, '&quot;')})" class="btn-primary text-white px-6 py-3 rounded-xl flex-1 font-semibold">âœ“ Sim, Gerar PDF</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    // Substitua as funÃ§Ãµes existentes por estas:

// --- INÃCIO DA CORREÃ‡ÃƒO ---




// FunÃ§Ã£o Wrapper para SEM PDF
function processarVendaSemPDF(dadosVenda) {
    // 1. Verifica se jÃ¡ existe uma venda sendo processada para evitar duplicidade
    if (vendaEmProcessamento) return;
    
    // 2. Fecha manualmente a janelinha (modal) de confirmaÃ§Ã£o do PDF
    // Buscamos o elemento que contÃ©m o texto de confirmaÃ§Ã£o e o escondemos
    const modais = document.querySelectorAll('.fixed.inset-0');
    modais.forEach(modal => {
        if (!modal.classList.contains('hidden') && modal.innerText.includes('Gerar Recibo')) {
            modal.classList.add('hidden');
        }
    });

    // 3. Chama a funÃ§Ã£o principal passando 'false' para nÃ£o gerar o PDF
    processarVenda(dadosVenda, false);
    
    // 4. Fecha o modal principal de vendas (carrinho)
    if (typeof fecharModalVenda === 'function') {
        fecharModalVenda();
    }
}










// FunÃ§Ã£o Wrapper para COM PDF

async function processarVendaComPDF(dadosVenda) {
    // 1. Trava de seguranÃ§a
    if (vendaEmProcessamento) return;

    // 2. Localiza a janelinha de confirmaÃ§Ã£o (pelo texto do tÃ­tulo ou botÃ£o)
    // Procura qualquer modal aberto que tenha "Gerar Recibo" ou o botÃ£o "Sim, Gerar PDF"
    const modalConfirmacao = Array.from(document.querySelectorAll('.fixed.inset-0')).find(
        m => !m.classList.contains('hidden') && (m.innerText.includes('Gerar Recibo') || m.innerText.includes('Gerar PDF'))
    );

    // 3. Feedback Visual: Muda o texto do botÃ£o para "Gerando..." e bloqueia
    if (modalConfirmacao) {
        const btn = modalConfirmacao.querySelector('button.bg-green-600') || modalConfirmacao.querySelector('button');
        if (btn) {
            btn.innerHTML = 'â³ Gerando...'; // Mostra que estÃ¡ trabalhando
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    try {
        // 4. Processa a venda (Salva no banco e gera o PDF)
        // O 'await' garante que ele espere o PDF ficar pronto antes de fechar
        await processarVenda(dadosVenda, true);
        
    } catch (erro) {
        console.error("Erro no processo:", erro);
    } finally {
        // 5. FECHA TUDO (O Pulo do Gato)
        
        // Fecha a janelinha de confirmaÃ§Ã£o do PDF
        if (modalConfirmacao) {
            modalConfirmacao.classList.add('hidden'); 
            // Se precisar remover do DOM ou resetar o botÃ£o, pode fazer aqui
            // Mas adicionar 'hidden' jÃ¡ resolve visualmente
        }

        // Fecha o modal principal de vendas (carrinho)
        fecharModalVenda(); 
    }
}




// FunÃ§Ã£o Principal de Processamento
async function processarVenda(dadosVenda, gerarPDF) {
    // 1. TRAVA DE SEGURANÃ‡A (O Pulo do Gato)
    if (vendaEmProcessamento) {
        console.warn('Venda jÃ¡ estÃ¡ sendo processada. Clique ignorado.');
        return;
    }

    try {
        vendaEmProcessamento = true; // Ativa a trava

        // Atualiza botÃ£o principal (caso visÃ­vel)
        const btn = document.getElementById('btn-finalizar-venda');
        if(btn) {
            btn.disabled = true;
            btn.innerHTML = 'Processando...<span class="loading-spinner"></span>';
        }
        
        // Recupera forma de pagamento para salvar corretamente
        const formaPagamento = document.getElementById('forma-pagamento-venda').value;
        
        // Recria a lÃ³gica de descriÃ§Ã£o para salvar no banco (igual vocÃª jÃ¡ tinha)
        let descricaoFormaPagamento = '';
        let formasPagamentoArray = [];
        
        if (formaPagamento === 'misto') {
            // LÃ³gica do pagamento misto
            const forma1 = document.getElementById('misto-forma1').value;
            const forma2 = document.getElementById('misto-forma2').value;
            const forma3 = document.getElementById('misto-forma3').value;
            const valor1 = parseFloat(document.getElementById('misto-valor1').value) || 0;
            const valor2 = parseFloat(document.getElementById('misto-valor2').value) || 0;
            const valor3 = parseFloat(document.getElementById('misto-valor3').value) || 0;
            
            const labelsFormas = {
                'dinheiro': 'Dinheiro', 'pix': 'PIX',
                'cartao-debito': 'DÃ©bito', 'cartao-credito': 'CrÃ©dito'
            };
            
            formasPagamentoArray.push({ forma: forma1, valor: valor1 });
            formasPagamentoArray.push({ forma: forma2, valor: valor2 });
            if (forma3 && valor3 > 0) {
                formasPagamentoArray.push({ forma: forma3, valor: valor3 });
            }
            
            descricaoFormaPagamento = formasPagamentoArray
                .map(fp => `${labelsFormas[fp.forma] || fp.forma}: R$ ${fp.valor.toFixed(2)}`)
                .join(' + ');
        }
        
        // 2. SALVA O REGISTRO (Apenas uma vez garantido pela trava acima)
        criarRegistro({
            tipo: 'transacao',
            data: dataSelecionadaCaixa.toISOString().split('T')[0],
            tipo_transacao: 'entrada',
            categoria: 'venda',
            valor: dadosVenda.total,
            descricao: `Venda - ${carrinhoVendas.length} item(ns) - Desconto: ${dadosVenda.desconto}%${formaPagamento === 'misto' ? ' - Misto: ' + descricaoFormaPagamento : ''}`,
            forma_pagamento: formaPagamento,
            formas_pagamento_misto: formaPagamento === 'misto' ? formasPagamentoArray : null,
            produtos_vendidos: carrinhoVendas.map(item => ({
                produto_id: item.produto_id,
                nome: item.nome,
                quantidade: item.quantidade,
                valor_unitario: item.valor_unitario
            }))
        });
        
        // Baixa o estoque
        carrinhoVendas.forEach(item => {
            const produto = allData.find(p => p.__backendId === item.produto_id);
            if (produto) {
                produto.estoque -= item.quantidade;
                atualizarRegistro(produto);
            }
        });
        
        // 3. GERA O PDF (Se solicitado)
        if (gerarPDF) {
            await gerarReciboPDF(dadosVenda);
        }
        
        // 4. LIMPEZA E ATUALIZAÃ‡ÃƒO
        carrinhoVendas = [];
        document.getElementById('carrinho-desconto').value = '0';
        document.getElementById('forma-pagamento-venda').value = '';
        document.getElementById('campos-pagamento-misto').classList.add('hidden');
        
        // Limpar campos do misto
        ['misto-forma1', 'misto-forma2', 'misto-forma3', 
         'misto-valor1', 'misto-valor2', 'misto-valor3'].forEach(id => {
             const el = document.getElementById(id);
             if(el) el.value = '';
        });
        
        renderCarrinho();
        atualizarTotalizador();
        renderProdutosVenda();
        
        // Sincroniza dashboard
        sincronizarFechamento(dadosVenda.data);
        if (typeof atualizarDashboardCaixa === 'function') atualizarDashboardCaixa();
        
        showToast('âœ… Venda realizada com sucesso!', 'success');
        
    } catch (error) {
        console.error("Erro ao processar venda:", error);
        showToast('âŒ Erro ao processar venda', 'error');
    } finally {
        // 5. LIBERA A TRAVA (Importante!)
        const btn = document.getElementById('btn-finalizar-venda');
        if(btn) {
            btn.disabled = false;
            btn.innerHTML = ' âœ“ Finalizar Venda';
        }
        vendaEmProcessamento = false;
    }
}
// --- FIM DA CORREÃ‡ÃƒO ---
    
    function limparCarrinho() {
      carrinhoVendas = [];
      document.getElementById('carrinho-desconto').value = '0';
      document.getElementById('forma-pagamento-venda').value = '';
      renderCarrinho();
      atualizarTotalizador();
    }

    // PRODUTOS
    document.getElementById('form-produto').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const produto = {
        tipo: 'produto',
        nome: document.getElementById('produto-nome').value.trim(),
        validade: document.getElementById('produto-validade').value,
        estoque: parseInt(document.getElementById('produto-estoque').value),
        estoque_minimo: parseInt(document.getElementById('produto-estoque-minimo').value),
        valor_custo: parseFloat(document.getElementById('produto-valor-custo').value),
        valor_venda: parseFloat(document.getElementById('produto-valor-venda').value)
      };
      
      if (produtoEmEdicao) {
        const registro = allData.find(p => p.__backendId === produtoEmEdicao);
        if (registro) {
          Object.assign(registro, produto);
          atualizarRegistro(registro);
          showToast('âœ… Produto atualizado!', 'success');
          produtoEmEdicao = null;
        }
      } else {
        criarRegistro(produto);
        showToast('âœ… Produto cadastrado!', 'success');
      }
      
      this.reset();
      document.getElementById('produto-validade').value = new Date().toISOString().split('T')[0];
    });p

    function renderProdutos() {
      let produtos = allData.filter(item => item.tipo === 'produto');
      const busca = document.getElementById('busca-produto').value.toLowerCase();
      
      if (busca) {
        produtos = produtos.filter(p => p.nome.toLowerCase().includes(busca));
      }
      
      if (filtroProdutoAtual !== 'todos') {
        produtos = produtos.filter(p => {
          if (filtroProdutoAtual === 'positivo') return p.estoque > p.estoque_minimo;
          if (filtroProdutoAtual === 'baixo') return p.estoque > 0 && p.estoque <= p.estoque_minimo;
          if (filtroProdutoAtual === 'sem') return p.estoque === 0;
          return true;
        });
      }
      
      const tbody = document.getElementById('produtos-list');
      
      if (produtos.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-4 py-12 text-center text-gray-500">
              <div class="flex flex-col items-center gap-3">
                <span class="text-5xl opacity-20">ğŸ“¦</span>
                <span>Nenhum produto encontrado</span>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = produtos.map(produto => {
        const margem = ((produto.valor_venda - produto.valor_custo) / produto.valor_custo * 100).toFixed(1);
        let statusEstoque = '';
        let corEstoque = '';
        
        if (produto.estoque === 0) {
          statusEstoque = 'âŒ Sem estoque';
          corEstoque = 'text-red-600 font-bold';
        } else if (produto.estoque <= produto.estoque_minimo) {
          statusEstoque = 'âš ï¸ Estoque baixo';
          corEstoque = 'text-orange-600 font-bold';
        } else {
          statusEstoque = 'âœ… OK';
          corEstoque = 'text-green-600 font-bold';
        }
        
        const dataValidade = new Date(produto.validade + 'T00:00:00');
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        const diasRestantes = Math.ceil((dataValidade - hoje) / (1000 * 60 * 60 * 24));
        
        let alertaValidade = '';
        if (diasRestantes < 0) {
          alertaValidade = '<span class="text-red-600 font-bold text-xs">âš ï¸ VENCIDO</span>';
        } else if (diasRestantes <= 30) {
          alertaValidade = '<span class="text-orange-600 font-bold text-xs">âš ï¸ Vence em breve</span>';
        }
        
        return `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-4 py-4">
              <div class="font-semibold text-gray-800">${produto.nome}</div>
            </td>
            <td class="px-4 py-4">
              <div>${new Date(produto.validade + 'T00:00:00').toLocaleDateString('pt-BR')}</div>
              ${alertaValidade}
            </td>
            <td class="px-4 py-4 ${corEstoque}">${produto.estoque}</td>
            <td class="px-4 py-4 text-gray-600">${produto.estoque_minimo}</td>
            <td class="px-4 py-4 text-gray-600">R$ ${produto.valor_custo.toFixed(2)}</td>
            <td class="px-4 py-4 font-bold text-green-600">R$ ${produto.valor_venda.toFixed(2)}</td>
            <td class="px-4 py-4">
              <span class="px-3 py-1 rounded-lg text-sm font-semibold ${margem >= 20 ? 'bg-green-100 text-green-700' : margem >= 10 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">
                ${margem}%
              </span>
            </td>
            <td class="px-4 py-4">
              <div class="flex gap-2">
                <button onclick="editarProduto('${produto.__backendId}')" class="text-blue-600 hover:text-blue-800 font-semibold text-sm">âœï¸ Editar</button>
                <button onclick="deletarProduto('${produto.__backendId}')" class="text-red-600 hover:text-red-800 font-semibold text-sm">ğŸ—‘ï¸ Excluir</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function atualizarStatusProdutos() {
      const produtos = allData.filter(item => item.tipo === 'produto');
      const semEstoque = produtos.filter(p => p.estoque === 0).length;
      const estoqueBaixo = produtos.filter(p => p.estoque > 0 && p.estoque <= p.estoque_minimo).length;
      const estoqueOk = produtos.filter(p => p.estoque > p.estoque_minimo).length;
      
      document.getElementById('status-sem-estoque').textContent = semEstoque;
      document.getElementById('status-estoque-baixo').textContent = estoqueBaixo;
      document.getElementById('status-estoque-ok').textContent = estoqueOk;
    }

    function filtrarProdutos(filtro) {
      filtroProdutoAtual = filtro;
      
      document.querySelectorAll('[id^="filtro-"]').forEach(btn => {
        btn.classList.remove('bg-green-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      
      document.getElementById(`filtro-${filtro}`).classList.remove('bg-gray-200', 'text-gray-700');
      document.getElementById(`filtro-${filtro}`).classList.add('bg-green-600', 'text-white');
      
      renderProdutos();
    }

    function editarProduto(id) {
      const produto = allData.find(p => p.__backendId === id);
      if (!produto) return;
      
      document.getElementById('produto-nome').value = produto.nome;
      document.getElementById('produto-validade').value = produto.validade;
      document.getElementById('produto-estoque').value = produto.estoque;
      document.getElementById('produto-estoque-minimo').value = produto.estoque_minimo;
      document.getElementById('produto-valor-custo').value = produto.valor_custo;
      document.getElementById('produto-valor-venda').value = produto.valor_venda;
      
      produtoEmEdicao = id;
      
      document.querySelector('#form-produto button[type="submit"]').textContent = 'Atualizar Produto';
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
      showToast('âœï¸ Editando produto...', 'success');
    }

    function deletarProduto(id) {
      const produto = allData.find(p => p.__backendId === id);
      if (!produto) return;
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
          <h3 class="text-2xl font-bold mb-4 text-gray-800">âš ï¸ Confirmar ExclusÃ£o</h3>
          <p class="text-gray-600 mb-6">Deseja excluir <strong>${produto.nome}</strong>?</p>
          <div class="flex gap-3">
            <button onclick="this.closest('.fixed').remove()" class="btn-secondary text-white px-6 py-3 rounded-xl flex-1 font-semibold">X</button>
            <button onclick="confirmarDeleteProduto('${id}')" class="btn-danger text-white px-6 py-3 rounded-xl flex-1 font-semibold">Excluir</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function confirmarDeleteProduto(id) {
      const produto = allData.find(p => p.__backendId === id);
      if (produto) {
        deletarRegistro(produto);
        showToast('âœ… Produto excluÃ­do!', 'success');
      }
      document.querySelectorAll('.fixed.inset-0').forEach(el => el.remove());
    }

    // CLIENTES
    document.getElementById('form-cliente').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const cliente = {
        tipo: 'cliente',
        data_cadastro: document.getElementById('cliente-data-cadastro').value,
        nome: document.getElementById('cliente-nome').value.trim(),
        telefone1: document.getElementById('cliente-telefone1').value.trim(),
        telefone2: document.getElementById('cliente-telefone2').value.trim(),
        cep: document.getElementById('cliente-cep').value.trim(),
        estado: document.getElementById('cliente-estado').value.trim(),
        cidade: document.getElementById('cliente-cidade').value.trim(),
        rua: document.getElementById('cliente-rua').value.trim(),
        numero: document.getElementById('cliente-numero').value.trim(),
        complemento: document.getElementById('cliente-complemento').value.trim(),
        bairro: document.getElementById('cliente-bairro').value.trim(),
        ponto_referencia: document.getElementById('cliente-ponto-ref').value.trim()
      };
      
      if (clienteEmEdicao) {
        const registro = allData.find(c => c.__backendId === clienteEmEdicao);
        if (registro) {
          Object.assign(registro, cliente);
          atualizarRegistro(registro);
          showToast('âœ… Cliente atualizado!', 'success');
          clienteEmEdicao = null;
        }
      } else {
        criarRegistro(cliente);
        showToast('âœ… Cliente cadastrado!', 'success');
      }
      
      this.reset();
      document.getElementById('cliente-data-cadastro').value = new Date().toISOString().split('T')[0];
    });

    function renderClientes() {
      let clientes = allData.filter(item => item.tipo === 'cliente');
      const busca = document.getElementById('busca-cliente').value.toLowerCase();
      
      if (busca) {
        clientes = clientes.filter(c => c.nome.toLowerCase().includes(busca));
      }
      
      const tbody = document.getElementById('clientes-list');
      
      if (clientes.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-12 text-center text-gray-500">
              <div class="flex flex-col items-center gap-3">
                <span class="text-5xl opacity-20">ğŸ‘¥</span>
                <span>Nenhum cliente encontrado</span>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = clientes.map(cliente => {
        const atendimentos = allData.filter(a => a.tipo === 'atendimento' && a.cliente_id === cliente.__backendId);
        const totalAtendimentos = atendimentos.length;
        
        return `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-4 py-4 text-gray-600">${new Date(cliente.data_cadastro + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
            <td class="px-4 py-4">
              <div class="font-semibold text-gray-800">${cliente.nome}</div>
            </td>
            <td class="px-4 py-4 text-gray-600">${cliente.telefone1}</td>
            <td class="px-4 py-4">
              <span class="px-3 py-1 rounded-lg text-sm font-semibold bg-blue-100 text-blue-700">
                ${totalAtendimentos} receituÃ¡rio(s)
              </span>
            </td>
            <td class="px-4 py-4">
              <div class="flex gap-2">
                <button onclick="editarCliente('${cliente.__backendId}')" class="text-blue-600 hover:text-blue-800 font-semibold text-sm">âœï¸ Editar</button>
                <button onclick="deletarCliente('${cliente.__backendId}')" class="text-red-600 hover:text-red-800 font-semibold text-sm">ğŸ—‘ï¸ Excluir</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function atualizarStatusClientes() {
      const clientes = allData.filter(item => item.tipo === 'cliente');
      const atendimentos = allData.filter(item => item.tipo === 'atendimento');
      
      const aguardando = atendimentos.filter(a => a.status === 'aguardando').length;
      const confirmados = atendimentos.filter(a => a.status === 'confirmado').length;
      const finalizados = atendimentos.filter(a => a.status === 'finalizado').length;
      
      document.getElementById('status-total-clientes').textContent = clientes.length;
      document.getElementById('status-clientes-aguardando').textContent = aguardando;
      document.getElementById('status-clientes-confirmados').textContent = confirmados;
      document.getElementById('status-clientes-finalizados').textContent = finalizados;
    }

    function editarCliente(id) {
      const cliente = allData.find(c => c.__backendId === id);
      if (!cliente) return;
      
      document.getElementById('cliente-data-cadastro').value = cliente.data_cadastro;
      document.getElementById('cliente-nome').value = cliente.nome;
      document.getElementById('cliente-telefone1').value = cliente.telefone1;
      document.getElementById('cliente-telefone2').value = cliente.telefone2 || '';
      document.getElementById('cliente-cep').value = cliente.cep || '';
      document.getElementById('cliente-estado').value = cliente.estado || '';
      document.getElementById('cliente-cidade').value = cliente.cidade || '';
      document.getElementById('cliente-rua').value = cliente.rua || '';
      document.getElementById('cliente-numero').value = cliente.numero || '';
      document.getElementById('cliente-complemento').value = cliente.complemento || '';
      document.getElementById('cliente-bairro').value = cliente.bairro || '';
      document.getElementById('cliente-ponto-ref').value = cliente.ponto_referencia || '';
      
      clienteEmEdicao = id;
      
      document.querySelector('#form-cliente button[type="submit"]').textContent = 'Atualizar Cliente';
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
      showToast('âœï¸ Editando cliente...', 'success');
    }

    function deletarCliente(id) {
      const cliente = allData.find(c => c.__backendId === id);
      if (!cliente) return;
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
          <h3 class="text-2xl font-bold mb-4 text-gray-800">âš ï¸ Confirmar ExclusÃ£o</h3>
          <p class="text-gray-600 mb-6">Deseja excluir <strong>${cliente.nome}</strong>?</p>
          <div class="flex gap-3">
            <button onclick="this.closest('.fixed').remove()" class="btn-secondary text-white px-6 py-3 rounded-xl flex-1 font-semibold">X</button>
            <button onclick="confirmarDeleteCliente('${id}')" class="btn-danger text-white px-6 py-3 rounded-xl flex-1 font-semibold">Excluir</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function confirmarDeleteCliente(id) {
      const cliente = allData.find(c => c.__backendId === id);
      if (cliente) {
        deletarRegistro(cliente);
        showToast('âœ… Cliente excluÃ­do!', 'success');
      }
      document.querySelectorAll('.fixed.inset-0').forEach(el => el.remove());
    }

    // ATENDIMENTOS
    document.getElementById('form-atendimento').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!clienteSelecionadoAtendimento) {
        showToast('âš ï¸ Selecione um cliente', 'error');
        return;
      }
      
      const atendimento = {
        tipo: 'atendimento',
        data: document.getElementById('atend-data').value,
        horario: document.getElementById('atend-horario').value,
        origem: document.getElementById('atend-origem').value.trim(),
        cliente_id: clienteSelecionadoAtendimento.__backendId,
        cliente_nome: clienteSelecionadoAtendimento.nome,
        cliente_telefone: clienteSelecionadoAtendimento.telefone1,
        prescricao: document.getElementById('atend-prescricao').value.trim(),
        status: 'aguardando'
      };
      
      criarRegistro(atendimento);
      showToast('âœ… Atendimento registrado!', 'success');
      
      this.reset();
      document.getElementById('atend-data').value = new Date().toISOString().split('T')[0];
      clienteSelecionadoAtendimento = null;
      document.getElementById('cliente-sugestoes').classList.add('hidden');
    });

    function buscarClienteAtendimento() {
      const busca = document.getElementById('atend-cliente').value.toLowerCase();
      const container = document.getElementById('cliente-sugestoes');
      
      if (busca.length < 2) {
        container.classList.add('hidden');
        return;
      }
      
      const clientes = allData.filter(item => 
        item.tipo === 'cliente' && 
        item.nome.toLowerCase().includes(busca)
      );
      
      if (clientes.length === 0) {
        container.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">Nenhum cliente encontrado</div>';
        container.classList.remove('hidden');
        return;
      }
      
      container.innerHTML = clientes.map(cliente => `
        <div class="cliente-sugestao" onclick='selecionarClienteAtendimento(${JSON.stringify(cliente)})'>
          <div class="font-semibold text-gray-800 text-sm">${cliente.nome}</div>
          <div class="text-xs text-gray-600">${cliente.telefone1}</div>
        </div>
      `).join('');
      
      container.classList.remove('hidden');
    }

    function selecionarClienteAtendimento(cliente) {
      clienteSelecionadoAtendimento = cliente;
      document.getElementById('atend-cliente').value = cliente.nome;
      document.getElementById('cliente-sugestoes').classList.add('hidden');
      showToast('âœ… Cliente selecionado', 'success');
    }

    function renderAtendimentos() {
      let atendimentos = allData.filter(item => item.tipo === 'atendimento');
      
      // Aplicar busca
      const busca = document.getElementById('busca-atendimento').value.toLowerCase();
      if (busca) {
        atendimentos = atendimentos.filter(a => 
          a.cliente_nome.toLowerCase().includes(busca) ||
          a.origem.toLowerCase().includes(busca) ||
          a.prescricao.toLowerCase().includes(busca)
        );
      }
      
      // Aplicar filtro de status
      if (filtroAtendimentoAtual !== 'todos') {
        atendimentos = atendimentos.filter(a => a.status === filtroAtendimentoAtual);
      }
      
      const tbody = document.getElementById('atendimentos-list');
      
      if (atendimentos.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-4 py-12 text-center text-gray-500">
              <div class="flex flex-col items-center gap-3">
                <span class="text-5xl opacity-20">ğŸ”„</span>
                <span>Nenhum atendimento cadastrado</span>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = atendimentos.map(atend => {
        let badgeStatus = '';
        if (atend.status === 'aguardando') badgeStatus = 'bg-orange-100 text-orange-700';
        if (atend.status === 'confirmado') badgeStatus = 'bg-green-100 text-green-700';
        if (atend.status === 'finalizado') badgeStatus = 'bg-purple-100 text-purple-700';
        if (atend.status === 'nao_respondida') badgeStatus = 'bg-red-100 text-red-700';
        
        const statusTexto = {
          'aguardando': 'â³ Aguardando',
          'confirmado': 'âœ… Confirmado',
          'finalizado': 'ğŸ‰ Finalizado',
          'nao_respondida': 'âŒ NÃ£o Respondida'
        }[atend.status];
        
        return `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-4 py-4 text-gray-600">${new Date(atend.data + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
            <td class="px-4 py-4 text-gray-600">${atend.horario}</td>
            <td class="px-4 py-4 text-gray-600">${atend.origem}</td>
            <td class="px-4 py-4 font-semibold text-gray-800">${atend.cliente_nome}</td>
            <td class="px-4 py-4 text-gray-600">${atend.cliente_telefone}</td>
            <td class="px-4 py-4">
              <span class="px-3 py-1 rounded-lg text-sm font-semibold ${badgeStatus}">${statusTexto}</span>
            </td>
            <td class="px-4 py-4 text-sm text-gray-600 max-w-xs truncate">${atend.prescricao}</td>
            <td class="px-4 py-4">
              <select onchange="alterarStatusAtendimento('${atend.__backendId}', this.value)" class="text-sm border-2 border-gray-200 rounded-lg px-2 py-1">
                <option value="">Alterar status...</option>
                <option value="aguardando"> Aguardando</option>
                <option value="confirmado"> Confirmado</option>
                <option value="finalizado">ğŸ‰ Finalizado</option>
                <option value="nao_respondida">âŒ NÃ£o Respondida</option>
              </select>
            </td>
          </tr>
        `;
      }).join('');
    }

    function alterarStatusAtendimento(id, novoStatus) {
      if (!novoStatus) return;
      
      const atendimento = allData.find(a => a.__backendId === id);
      if (atendimento) {
        atendimento.status = novoStatus;
        atualizarRegistro(atendimento);
        showToast('âœ… Status atualizado!', 'success');
      }
    }

    function atualizarStatusAtendimentos() {
      const atendimentos = allData.filter(item => item.tipo === 'atendimento');
      
      const andamento = atendimentos.filter(a => !a.status || a.status === 'andamento').length;
      const aguardando = atendimentos.filter(a => a.status === 'aguardando').length;
      const confirmados = atendimentos.filter(a => a.status === 'confirmado').length;
      const finalizados = atendimentos.filter(a => a.status === 'finalizado').length;
      const naoRespondidas = atendimentos.filter(a => a.status === 'nao_respondida').length;
      
      document.getElementById('status-atend-andamento').textContent = andamento;
      document.getElementById('status-atend-aguardando').textContent = aguardando;
      document.getElementById('status-atend-confirmados').textContent = confirmados;
      document.getElementById('status-atend-finalizados').textContent = finalizados;
      document.getElementById('status-atend-nao-respondidas').textContent = naoRespondidas;
    }

    function mudarAbaGerenciamento(aba) {
      document.querySelectorAll('.tab-gerenciamento').forEach(tab => tab.classList.remove('active'));
      document.getElementById(`tab-${aba}`).classList.add('active');
      
      document.querySelectorAll('.gerenciamento-content').forEach(content => content.classList.add('hidden'));
      document.getElementById(`gerenciamento-content-${aba}`).classList.remove('hidden');
    }

    function filtrarAtendimentos(filtro) {
      filtroAtendimentoAtual = filtro;
      
      document.querySelectorAll('[id^="filtro-atend-"]').forEach(btn => {
        btn.classList.remove('bg-green-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      
      document.getElementById(`filtro-atend-${filtro}`).classList.remove('bg-gray-200', 'text-gray-700');
      document.getElementById(`filtro-atend-${filtro}`).classList.add('bg-green-600', 'text-white');
      
      renderAtendimentos();
    }

    // CAIXA
    document.getElementById('form-transacao').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const transacao = {
        tipo: 'transacao',
        data: document.getElementById('trans-data').value,
        tipo_transacao: document.getElementById('trans-tipo').value,
        categoria: document.getElementById('trans-categoria').value,
        valor: parseFloat(document.getElementById('trans-valor').value),
        descricao: document.getElementById('trans-descricao').value.trim(),
        forma_pagamento: document.getElementById('trans-forma-pagamento').value
      };
      
      criarRegistro(transacao);
      showToast('âœ… TransaÃ§Ã£o registrada!', 'success');
      
      this.reset();
      document.getElementById('trans-data').value = new Date().toISOString().split('T')[0];
    });

   function atualizarDashboardCaixa() {
    // 1. Identifica a data que estÃ¡ selecionada no painel
    const hoje = dataSelecionadaCaixa.toISOString().split('T')[0];
    
    // 2. Filtra transaÃ§Ãµes APENAS do dia selecionado
    const transacoes = allData.filter(t => t.tipo === 'transacao' && t.data === hoje);
    
    // 3. Busca o Valor Inicial (Abertura) APENAS do dia selecionado
    const registroInicial = allData.find(item => item.tipo === 'valor_inicial' && item.data === hoje);
    const valorAbertura = registroInicial ? parseFloat(registroInicial.valor) : 0;

    // --- ATUALIZAÃ‡ÃƒO DOS CAMPOS DE INPUT (O que faz "zerar" ao mudar o dia) ---
    const displayAbertura = document.getElementById('display-valor-inicial');
    const inputAbertura = document.getElementById('input-valor-inicial');
    
    if (registroInicial) {
        displayAbertura.textContent = `R$ ${valorAbertura.toFixed(2)}`;
        inputAbertura.value = valorAbertura; // Preenche o input com o valor salvo
    } else {
        displayAbertura.textContent = 'R$ 0,00'; // Se nÃ£o tem registro, mostra zero
        inputAbertura.value = ''; // Limpa o input para um novo dia
    }

    // 4. CÃ¡lculos do Dia
    const vendasDia = transacoes.filter(t => t.categoria === 'venda').reduce((sum, t) => sum + t.valor, 0);
    const entradasDia = transacoes.filter(t => t.tipo_transacao === 'entrada').reduce((sum, t) => sum + t.valor, 0);
    const saidasDia = transacoes.filter(t => t.tipo_transacao === 'saida').reduce((sum, t) => sum + t.valor, 0);
    
    // CÃLCULO DO SALDO DO DIA (Valor Maior): Abertura + Entradas - SaÃ­das
    const saldoDia = valorAbertura + entradasDia - saidasDia;

    // 5. CÃ¡lculos do MÃªs (Acumulado)
    const mesAtual = dataSelecionadaCaixa.getMonth();
    const anoAtual = dataSelecionadaCaixa.getFullYear();
    
    const transacoesMes = allData.filter(t => {
        if (t.tipo !== 'transacao') return false;
        const d = new Date(t.data + 'T00:00:00');
        return d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
    });

    const valoresIniciaisMes = allData.filter(t => {
        if (t.tipo !== 'valor_inicial') return false;
        const d = new Date(t.data + 'T00:00:00');
        return d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
    });

    const somaIniciaisMes = valoresIniciaisMes.reduce((sum, t) => sum + t.valor, 0);
    const entradasMes = transacoesMes.filter(t => t.tipo_transacao === 'entrada').reduce((sum, t) => sum + t.valor, 0);
    const saidasMes = transacoesMes.filter(t => t.tipo_transacao === 'saida').reduce((sum, t) => sum + t.valor, 0);
    
    const saldoMes = somaIniciaisMes + entradasMes - saidasMes;

    // 6. Atualiza a Interface (DOM)
    document.getElementById('dash-vendas-dia').textContent = `R$ ${vendasDia.toFixed(2)}`;
    document.getElementById('dash-entradas-dia').textContent = `R$ ${entradasDia.toFixed(2)}`;
    document.getElementById('dash-saidas-dia').textContent = `R$ ${saidasDia.toFixed(2)}`;
    
    // Atualiza o SALDO ATUAL (O valor maior)
    const elSaldo = document.getElementById('dash-caixa-atual');
    elSaldo.textContent = `R$ ${saldoDia.toFixed(2)}`;
    
    // Atualiza o SALDO TOTAL DO MÃŠS
    document.getElementById('dash-saldo-total').textContent = `R$ ${saldoMes.toFixed(2)}`;

    // Se vocÃª tiver uma funÃ§Ã£o que desenha a lista de vendas, chame-a aqui
    if (typeof renderTransacoesCaixa === 'function') renderTransacoesCaixa();
}

    function renderTransacoes() {
      const hoje = dataSelecionadaCaixa.toISOString().split('T')[0];
      let transacoes = allData.filter(t => t.tipo === 'transacao' && t.data === hoje);
      
      if (filtroTransacaoAtual !== 'todas') {
        transacoes = transacoes.filter(t => t.tipo_transacao === filtroTransacaoAtual);
      }
      
      const dataInicio = document.getElementById('filtro-data-inicio').value;
      const dataFim = document.getElementById('filtro-data-fim').value;
      
      if (dataInicio) {
        transacoes = transacoes.filter(t => t.data >= dataInicio);
      }
      
      if (dataFim) {
        transacoes = transacoes.filter(t => t.data <= dataFim);
      }
      
      const tbody = document.getElementById('transacoes-list');
      
      if (transacoes.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="px-4 py-12 text-center text-gray-500">
              <div class="flex flex-col items-center gap-3">
                <span class="text-5xl opacity-20">ğŸ’°</span>
                <span>Nenhuma transaÃ§Ã£o encontrada</span>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = transacoes.map(trans => {
        const tipoClasse = trans.tipo_transacao === 'entrada' ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
        const tipoIcone = trans.tipo_transacao === 'entrada' ? 'ğŸ’µ' : 'ğŸ’¸';
        
        return `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-4 py-4 text-gray-600">${new Date(trans.data + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
            <td class="px-4 py-4">
              <span class="${tipoClasse}">${tipoIcone} ${trans.tipo_transacao === 'entrada' ? 'Entrada' : 'SaÃ­da'}</span>
            </td>
            <td class="px-4 py-4 text-gray-600 capitalize">${trans.categoria.replace('-', ' ')}</td>
            <td class="px-4 py-4 text-gray-600 text-sm">${trans.descricao}</td>
            <td class="px-4 py-4 text-gray-600 text-sm capitalize">${trans.forma_pagamento.replace('-', ' ')}</td>
            <td class="px-4 py-4 ${tipoClasse}">R$ ${trans.valor.toFixed(2)}</td>
            <td class="px-4 py-4">
              <button onclick="deletarTransacao('${trans.__backendId}')" class="text-red-600 hover:text-red-800 font-semibold text-sm">ğŸ—‘ï¸ Excluir</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function filtrarTransacoes(tipo) {
      filtroTransacaoAtual = tipo;
      
      document.querySelectorAll('[id^="filtro-trans-"]').forEach(btn => {
        btn.classList.remove('bg-green-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      
      document.getElementById(`filtro-trans-${tipo}`).classList.remove('bg-gray-200', 'text-gray-700');
      document.getElementById(`filtro-trans-${tipo}`).classList.add('bg-green-600', 'text-white');
      
      renderTransacoes();
    }

    function aplicarFiltroDatas() {
      renderTransacoes();
    }

    function limparFiltros() {
      document.getElementById('filtro-data-inicio').value = '';
      document.getElementById('filtro-data-fim').value = '';
      filtroTransacaoAtual = 'todas';
      
      document.querySelectorAll('[id^="filtro-trans-"]').forEach(btn => {
        btn.classList.remove('bg-green-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      
      document.getElementById('filtro-trans-todas').classList.remove('bg-gray-200', 'text-gray-700');
      document.getElementById('filtro-trans-todas').classList.add('bg-green-600', 'text-white');
      
      renderTransacoes();
    }

    function deletarTransacao(id) {
      const transacao = allData.find(t => t.__backendId === id);
      if (transacao) {
        deletarRegistro(transacao);
        showToast('âœ… TransaÃ§Ã£o excluÃ­da!', 'success');
      }
    }

    function mudarAbaCaixa(aba) {
      document.querySelectorAll('.tab-gerenciamento').forEach(tab => tab.classList.remove('active'));
      document.getElementById(`tab-caixa-${aba}`).classList.add('active');
      
      document.querySelectorAll('.caixa-content').forEach(content => content.classList.add('hidden'));
      document.getElementById(`caixa-content-${aba}`).classList.remove('hidden');
    }

    function mudarDiaCaixa(dias) {
      dataSelecionadaCaixa.setDate(dataSelecionadaCaixa.getDate() + dias);
      atualizarDisplayData();
      atualizarDashboardCaixa();
      renderTransacoes();
    }

    function irParaHoje() {
      dataSelecionadaCaixa = new Date();
      atualizarDisplayData();
      atualizarDashboardCaixa();
      renderTransacoes();
    }

    function atualizarDisplayData() {
      const dataFormatada = dataSelecionadaCaixa.toLocaleDateString('pt-BR');
      document.getElementById('data-selecionada-display').textContent = dataFormatada;
    }

    function abrirModalValorInicial() {
      const modal = document.getElementById('modal-valor-inicial');
      const dataRecibo = new Date().toLocaleDateString('pt-BR');

      
      document.getElementById('modal-valor-titulo').textContent = 'ğŸ’µ Registrar Valor do Dia';
      document.getElementById('label-valor-inicial').textContent = 'Valor do Caixa (R$)';
      document.getElementById('btn-submit-valor').textContent = 'Registrar';
      document.getElementById('valor-inicial-valor').value = '';
      document.getElementById('valor-inicial-data').value = hoje;
      document.getElementById('valor-inicial-obs').value = '';
      
      modal.classList.remove('hidden');
    }

    function fecharModalValorInicial() {
      document.getElementById('modal-valor-inicial').classList.add('hidden');
      document.getElementById('form-valor-inicial').reset();
    }

    document.getElementById('form-valor-inicial').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const data = document.getElementById('valor-inicial-data').value;
      const valorInformado = parseFloat(document.getElementById('valor-inicial-valor').value);
      const obs = document.getElementById('valor-inicial-obs').value.trim();
      
      criarRegistro({
        tipo: 'valor_inicial',
        data: data,
        valor: valorInformado,
        observacoes: obs || '',
        horario_registro: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
      });
      
      showToast('âœ… Valor registrado com sucesso!', 'success');
      fecharModalValorInicial();
      atualizarDashboardCaixa();
    });

    // GRÃFICOS
    function renderGraficos() {
      renderGraficoFormasPagamento();
      renderGraficoProdutosVendidos();
    }

    function renderGraficoFormasPagamento() {
      const hoje = dataSelecionadaCaixa.toISOString().split('T')[0];
      const transacoes = allData.filter(t => t.tipo === 'transacao' && t.data === hoje);
      
      // Contar formas de pagamento
      const formasPagamento = {};
      transacoes.forEach(t => {
        if (t.forma_pagamento) {
          if (t.forma_pagamento === 'misto' && t.formas_pagamento_misto) {
            // Para pagamento misto, contar cada forma individualmente
            t.formas_pagamento_misto.forEach(fp => {
              formasPagamento[fp.forma] = (formasPagamento[fp.forma] || 0) + 1;
            });
          } else {
            formasPagamento[t.forma_pagamento] = (formasPagamento[t.forma_pagamento] || 0) + 1;
          }
        }
      });
      
      const canvas = document.getElementById('grafico-formas-pagamento');
      const ctx = canvas.getContext('2d');
      const legenda = document.getElementById('legenda-formas-pagamento');
      
      // Limpar canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (Object.keys(formasPagamento).length === 0) {
        ctx.fillStyle = '#9CA3AF';
        ctx.font = 'bold 14px Inter';
        ctx.textAlign = 'center';
        ctx.fillText('Nenhuma transaÃ§Ã£o', canvas.width / 2, canvas.height / 2);
        legenda.innerHTML = '<p class="text-gray-500 text-sm text-center">Sem dados para exibir</p>';
        return;
      }
      
      const cores = ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];
      const labels = {
        'dinheiro': 'ğŸ’µ Dinheiro',
        'pix': 'ğŸ“± PIX',
        'cartao-debito': 'ğŸ’³ DÃ©bito',
        'cartao-credito': 'ğŸ’³ CrÃ©dito',
        'transferencia': 'ğŸ¦ TransferÃªncia',
        'boleto': 'ğŸ“„ Boleto'
      };
      
      // Calcular total e percentuais
      const total = Object.values(formasPagamento).reduce((sum, val) => sum + val, 0);
      const dados = Object.entries(formasPagamento).map(([forma, quantidade]) => ({
        forma,
        quantidade,
        percentual: (quantidade / total) * 100
      }));
      
      // Desenhar grafico de pizza
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 120;
      let currentAngle = -Math.PI / 2;
      
      dados.forEach((item, index) => {
        const sliceAngle = (item.percentual / 100) * 2 * Math.PI;
        
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = cores[index % cores.length];
        ctx.fill();
        
        currentAngle += sliceAngle;
      });
      
      // Renderizar legenda
      legenda.innerHTML = dados.map((item, index) => `
        <div class="flex items-center justify-between text-sm">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded" style="background: ${cores[index % cores.length]}"></div>
            <span class="text-gray-700">${labels[item.forma] || item.forma}</span>
          </div>
          <span class="font-bold text-gray-800">${item.quantidade} (${item.percentual.toFixed(1)}%)</span>
        </div>
      `).join('');
    }

    function renderGraficoProdutosVendidos() {
      const hoje = dataSelecionadaCaixa.toISOString().split('T')[0];
      const transacoes = allData.filter(t => t.tipo === 'transacao' && t.data === hoje && t.categoria === 'venda');
      
      // Extrair produtos vendidos das transaÃ§Ãµes
      const produtosVendidos = {};
      
      transacoes.forEach(t => {
        if (t.produtos_vendidos && Array.isArray(t.produtos_vendidos)) {
          t.produtos_vendidos.forEach(produto => {
            produtosVendidos[produto.nome] = (produtosVendidos[produto.nome] || 0) + produto.quantidade;
          });
        }
      });
      
      const ranking = document.getElementById('ranking-produtos-vendidos');
      
      if (Object.keys(produtosVendidos).length === 0) {
        ranking.innerHTML = '<p class="text-gray-500 text-sm text-center py-8">Nenhuma venda hoje</p>';
        return;
      }
      
      const cores = ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6'];
      const medalhaCores = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'];
      
      // Ordenar e pegar top 5
      const dados = Object.entries(produtosVendidos)
        .map(([produto, quantidade]) => ({ produto, quantidade }))
        .sort((a, b) => b.quantidade - a.quantidade)
        .slice(0, 5);
      
      // Encontrar quantidade mÃ¡xima para calcular largura das barras
      const maxQuantidade = Math.max(...dados.map(d => d.quantidade));
      
      // Renderizar ranking
      ranking.innerHTML = dados.map((item, index) => {
        const larguraBarra = (item.quantidade / maxQuantidade) * 100;
        const nomeTruncado = item.produto.length > 20 ? item.produto.substring(0, 20) + '...' : item.produto;
        
        return `
          <div class="relative group">
            <div class="flex items-center gap-3 mb-1">
              <span class="text-2xl">${medalhaCores[index]}</span>
              <span class="text-sm font-semibold text-gray-700 flex-1 cursor-help" title="${item.produto}">${nomeTruncado}</span>
              <span class="text-sm font-bold text-gray-800">${item.quantidade} un.</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
              <div class="h-full rounded-full transition-all duration-500" style="width: ${larguraBarra}%; background: ${cores[index % cores.length]}"></div>
            </div>
            <!-- Tooltip ao passar o mouse -->
            <div class="absolute left-0 -top-12 bg-gray-800 text-white px-3 py-2 rounded-lg text-xs font-semibold opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10 shadow-lg">
              ${item.produto}
              <div class="absolute left-4 -bottom-1 w-2 h-2 bg-gray-800 transform rotate-45"></div>
            </div>
          </div>
        `;
      }).join('');
    }





    // ==========================================
// === SCRIPT DE ABERTURA DE CAIXA (FIX) ===
// ==========================================

// 1. FunÃ§Ã£o para Salvar o Valor no LocalStorage
function salvarValorInicial() {
    const input = document.getElementById('input-valor-inicial');
    
    if (!input || input.value === '') {
        showToast('âš ï¸ Digite um valor vÃ¡lido!', 'error');
        return;
    }

    const valor = parseFloat(input.value);
    
    // Garante que a data estÃ¡ correta
    if (!dataSelecionadaCaixa) dataSelecionadaCaixa = new Date();
    const dataFormatada = dataSelecionadaCaixa.toISOString().split('T')[0];

    // Procura se jÃ¡ existe valor inicial para hoje
    const index = allData.findIndex(item => item.tipo === 'valor_inicial' && item.data === dataFormatada);

    if (index !== -1) {
        // Atualiza existente
        allData[index].valor = valor;
        allData[index].__updatedAt = new Date().toISOString();
        console.log('Valor atualizado para:', valor);
    } else {
        // Cria novo
        criarRegistro({
            tipo: 'valor_inicial',
            data: dataFormatada,
            valor: valor,
            descricao: 'Abertura de Caixa' // DescriÃ§Ã£o interna
        });
        console.log('Novo valor criado:', valor);
    }

    salvarDados(); // Grava no navegador
    atualizarDashboardCaixa(); // ForÃ§a atualizaÃ§Ã£o imediata da tela
    showToast('âœ… Valor de abertura salvo!', 'success');
}

// 2. FunÃ§Ã£o Auxiliar para Mostrar o Valor na Tela (Input e Texto)
function renderValorInicial() {
    const dataFormatada = dataSelecionadaCaixa.toISOString().split('T')[0];
    const registro = allData.find(item => item.tipo === 'valor_inicial' && item.data === dataFormatada);
    
    const display = document.getElementById('display-valor-inicial');
    const input = document.getElementById('input-valor-inicial');

    if (registro) {
        display.textContent = `R$ ${parseFloat(registro.valor).toFixed(2)}`;
        display.classList.add('text-blue-600');
        input.value = registro.valor; // MantÃ©m o input preenchido
    } else {
        display.textContent = 'R$ 0,00';
        display.classList.remove('text-blue-600');
        input.value = ''; // Limpa o input se nÃ£o tiver valor
    }
}

// 3. ATUALIZAÃ‡ÃƒO DO DASHBOARD (Substitui a antiga completamente)
// Esta funÃ§Ã£o soma: Abertura + Entradas - SaÃ­das
atualizarDashboardCaixa = function() {
    const hoje = dataSelecionadaCaixa.toISOString().split('T')[0];
    
    // Filtra transaÃ§Ãµes do dia
    const transacoes = allData.filter(t => t.tipo === 'transacao' && t.data === hoje);
    
    // Pega o Valor Inicial (Abertura)
    const registroInicial = allData.find(item => item.tipo === 'valor_inicial' && item.data === hoje);
    const valorAbertura = registroInicial ? parseFloat(registroInicial.valor) : 0;

    // Calcula totais
    const vendasDia = transacoes.filter(t => t.categoria === 'venda').reduce((sum, t) => sum + t.valor, 0);
    const entradasDia = transacoes.filter(t => t.tipo_transacao === 'entrada').reduce((sum, t) => sum + t.valor, 0);
    const saidasDia = transacoes.filter(t => t.tipo_transacao === 'saida').reduce((sum, t) => sum + t.valor, 0);
    
    // CÃLCULO FINAL DO CAIXA: (Dinheiro que comecei) + (Dinheiro que entrou) - (Dinheiro que saiu)
    const saldoDia = valorAbertura + entradasDia - saidasDia;

    // Atualiza os elementos da tela
    document.getElementById('dash-vendas-dia').textContent = `R$ ${vendasDia.toFixed(2)}`;
    document.getElementById('dash-entradas-dia').textContent = `R$ ${entradasDia.toFixed(2)}`;
    document.getElementById('dash-saidas-dia').textContent = `R$ ${saidasDia.toFixed(2)}`;
    
    // Atualiza o Saldo Total com cor
    const elSaldo = document.getElementById('dash-caixa-atual');
    elSaldo.textContent = `R$ ${saldoDia.toFixed(2)}`;
    
    // Ajusta a cor do card de saldo
    const cardSaldo = elSaldo.closest('.stat-card');
    if (cardSaldo) {
        if(saldoDia < 0) {
            cardSaldo.style.setProperty('--color-from', '#EF4444'); // Vermelho
            cardSaldo.style.setProperty('--color-to', '#DC2626');
        } else {
            cardSaldo.style.setProperty('--color-from', '#8B5CF6'); // Roxo Original
            cardSaldo.style.setProperty('--color-to', '#7C3AED');
        }
    }

    // Acumulado MÃªs (Apenas visualizaÃ§Ã£o extra)
    const mesAtual = dataSelecionadaCaixa.getMonth();
    const anoAtual = dataSelecionadaCaixa.getFullYear();
    const transacoesMes = allData.filter(t => {
        if (t.tipo !== 'transacao') return false;
        const d = new Date(t.data + 'T00:00:00');
        return d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
    });
    
    const saldoMes = transacoesMes.filter(t => t.tipo_transacao === 'entrada').reduce((sum, t) => sum + t.valor, 0) -
                     transacoesMes.filter(t => t.tipo_transacao === 'saida').reduce((sum, t) => sum + t.valor, 0);
                     
    document.getElementById('dash-saldo-total').textContent = `R$ ${saldoMes.toFixed(2)}`;

    // IMPERATIVO: Chama a funÃ§Ã£o que desenha o valor inicial na tela
    renderValorInicial();
};









function abrirModalSaida() {
    const modal = document.getElementById('modal-saida');
    if (modal) {
        modal.classList.remove('hidden');
        document.getElementById('saida-valor').focus();
    } else {
        console.error("Erro: O painel de saÃ­da nÃ£o foi encontrado no HTML.");
    }
}

function fecharModalSaida() {
    const modal = document.getElementById('modal-saida');
    if (modal) {
        modal.classList.add('hidden');
        // Limpa os campos
        document.getElementById('saida-valor').value = '';
        document.getElementById('saida-descricao').value = '';
    }
}

function registrarSaida() {
    const valor = parseFloat(document.getElementById('saida-valor').value);
    const descricao = document.getElementById('saida-descricao').value.trim();
    const categoria = document.getElementById('saida-categoria').value;
    
    // === CORREÃ‡ÃƒO ABAIXO ===
    // O erro estava aqui: document.getElementById('trans-data').value
    // Como 'trans-data' Ã© uma DIV e nÃ£o um input, trocamos para usar a variÃ¡vel global
    // que jÃ¡ controla a data do painel (dataSelecionadaCaixa).
    const dataRegistro = dataSelecionadaCaixa.toISOString().split('T')[0]; 
    
    // =======================

    if (!valor || valor <= 0 || !descricao) {
        showToast('âš ï¸ Preencha o valor e a descriÃ§Ã£o corretamente', 'error');
        return;
    }


    // Cria o objeto da transaÃ§Ã£o
    const novaSaida = {
        tipo: 'transacao',
        tipo_transacao: 'saida',
        data: dataRegistro,
        valor: valor,
        descricao: descricao,
        categoria: categoria,
        forma_pagamento: 'dinheiro',
        horario: new Date().toLocaleTimeString('pt-BR'),
        __backendId: 'ID_' + Date.now()
    };

    // Adiciona aos dados e salva
    allData.push(novaSaida);
    salvarDados();
    sincronizarFechamento(dataRegistro);
    showToast(`ğŸ’¸ SaÃ­da de R$ ${valor.toFixed(2)} registrada!`, 'success');
    
    // Fecha o modal e atualiza a tela
    fecharModalSaida();
    if (typeof atualizarDashboardCaixa === 'function') atualizarDashboardCaixa(); 
    if (typeof renderTransacoes === 'function') renderTransacoes();
}










// VariÃ¡vel para armazenar os fechamentos (deve ser salva no localStorage)
let historicoFechamentos = JSON.parse(localStorage.getItem('historicoFechamentos')) || [];

// FunÃ§Ã£o para verificar se o dia mudou e auto-registrar o fechamento
function verificarTrocaDeDia() {
    const hoje = new Date().toLocaleDateString('pt-BR');
    const ultimaData = localStorage.getItem('ultima_data_acesso');

    if (ultimaData && ultimaData !== hoje) {
        realizarFechamentoAutomatico(ultimaData);
    }
    localStorage.setItem('ultima_data_acesso', hoje);
}

function realizarFechamentoAutomatico(dataReferencia) {
    // Pegar dados do caixa do dia anterior
    const resumo = calcularResumoDia(dataReferencia);
    
    const novoFechamento = {
        data: dataReferencia,
        hora: "23:59:59",
        valorInicial: resumo.valorInicial,
        entradas: resumo.totalEntradas,
        saidas: resumo.totalSaidas,
        saldoFinal: (resumo.valorInicial + resumo.totalEntradas) - resumo.totalSaidas,
        tipo: "AutomÃ¡tico (Meia-noite)"
    };

    historicoFechamentos.push(novoFechamento);
    localStorage.setItem('historicoFechamentos', JSON.stringify(historicoFechamentos));
    
    // Opcional: Reiniciar valor inicial para o novo dia com o saldo anterior
    // localStorage.setItem('valor_inicial_dia', novoFechamento.saldoFinal);
}

function calcularResumoDia(dataAlvo) {
    // Filtra as transaÃ§Ãµes de 'allData' pela data informada
    const transacoesDia = allData.filter(t => t.data === dataAlvo);
    
    let entradas = 0;
    let saidas = 0;
    
    transacoesDia.forEach(t => {
        if (t.tipo_transacao === 'entrada' || t.tipo === 'venda') {
            entradas += parseFloat(t.valor || 0);
        } else if (t.tipo_transacao === 'saida') {
            saidas += parseFloat(t.valor || 0);
        }
    });

    return {
        totalEntradas: entradas,
        totalSaidas: saidas,
        valorInicial: parseFloat(localStorage.getItem('valor_inicial_dia')) || 0
    };
}

// FunÃ§Ãµes do Modal
function abrirModalHistorico() {
    document.getElementById('modal-historico').classList.remove('hidden');
    renderizarTabelaHistorico();
    renderizarGraficoMensal();
}

function fecharModalHistorico() {
    document.getElementById('modal-historico').classList.add('hidden');
}

function renderizarTabelaHistorico() {
    const body = document.getElementById('tabela-historico-body');
    body.innerHTML = historicoFechamentos.reverse().map(f => `
        <tr class="text-sm hover:bg-gray-50">
            <td class="p-3 border font-medium">${f.data} <span class="text-xs text-gray-400">${f.hora}</span></td>
            <td class="p-3 border text-gray-600">R$ ${f.valorInicial.toFixed(2)}</td>
            <td class="p-3 border text-green-600 font-semibold">+ R$ ${f.entradas.toFixed(2)}</td>
            <td class="p-3 border text-red-600 font-semibold">- R$ ${f.saidas.toFixed(2)}</td>
            <td class="p-3 border font-bold text-gray-800">R$ ${f.saldoFinal.toFixed(2)}</td>
            <td class="p-3 border text-xs"><span class="bg-gray-100 px-2 py-1 rounded">${f.tipo}</span></td>
        </tr>
    `).join('');
}

let meuGrafico = null;
function renderizarGraficoMensal() {
    const ctx = document.getElementById('graficoMensal').getContext('2d');
    
    // Agrupar dados por mÃªs para o grÃ¡fico
    const dadosMensais = historicoFechamentos.slice(-12); // Ãšltimos 12 fechamentos
    
    if (meuGrafico) meuGrafico.destroy();

    meuGrafico = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dadosMensais.map(f => f.data.substring(0, 5)), // Exibe DD/MM
            datasets: [{
                label: 'Saldo Final do Dia',
                data: dadosMensais.map(f => f.saldoFinal),
                backgroundColor: '#3b82f6',
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });
}

// Chame a verificaÃ§Ã£o ao iniciar o app
window.addEventListener('load', () => {
    verificarTrocaDeDia();
});









// FunÃ§Ã£o principal para sincronizar os dados de um dia especÃ­fico com o histÃ³rico
function sincronizarFechamento(dataAlvo) {
    // 1. Filtrar transaÃ§Ãµes e valor inicial para a data selecionada
    const transacoes = allData.filter(t => t.tipo === 'transacao' && t.data === dataAlvo);
    const registroInicial = allData.find(item => item.tipo === 'valor_inicial' && item.data === dataAlvo);
    
    const valorAbertura = registroInicial ? parseFloat(registroInicial.valor) : 0;
    const vendas = transacoes.filter(t => t.categoria === 'venda').reduce((sum, t) => sum + t.valor, 0);
    const entradas = transacoes.filter(t => t.tipo_transacao === 'entrada').reduce((sum, t) => sum + t.valor, 0);
    const saidas = transacoes.filter(t => t.tipo_transacao === 'saida').reduce((sum, t) => sum + t.valor, 0);
    
    // Saldo Final = Abertura + Entradas - SaÃ­das
    const saldoFinal = valorAbertura + entradas - saidas;

    // 2. Preparar o objeto de fechamento
    const dadosFechamento = {
        data: dataAlvo,
        valorInicial: valorAbertura,
        vendas: vendas,
        entradas: entradas,
        saidas: saidas,
        saldoFinal: saldoFinal,
        horario: new Date().toLocaleTimeString('pt-BR')
    };

    // 3. Atualizar o localStorage do HistÃ³rico
    let historico = JSON.parse(localStorage.getItem('historicoFechamentos') || '[]');
    const indexExistente = historico.findIndex(f => f.data === dataAlvo);

    if (indexExistente !== -1) {
        // Se jÃ¡ existe registro para esse dia, atualiza (para refletir novas vendas)
        historico[indexExistente] = dadosFechamento;
    } else {
        // Se Ã© a primeira vez clicando no botÃ£o para esse dia, adiciona
        historico.push(dadosFechamento);
    }

    // Ordenar por data
    historico.sort((a, b) => new Date(a.data) - new Date(b.data));
    
    localStorage.setItem('historicoFechamentos', JSON.stringify(historico));

    // 4. Atualizar a Interface e o GrÃ¡fico
    if (typeof renderHistorico === 'function') renderHistorico();
    if (typeof renderGraficoMensal === 'function') renderGraficoMensal();
}

// FunÃ§Ã£o chamada pelo botÃ£o "Registrar DiÃ¡ria"
function prepararFechamentoManual() {
    const dataAtual = dataSelecionadaCaixa.toISOString().split('T')[0];
    sincronizarFechamento(dataAtual);
    showToast('âœ… DiÃ¡ria registrada e histÃ³rico atualizado!', 'success');
}




function renderGraficoMensal() {
    const historico = JSON.parse(localStorage.getItem('historicoFechamentos') || '[]');
    const ctx = document.getElementById('graficoMensal').getContext('2d');
    
    // Pega os Ãºltimos 7 ou 30 registros para o grÃ¡fico
    const dadosRecentes = historico.slice(-7); 

    if (window.meuGrafico) window.meuGrafico.destroy();

    window.meuGrafico = new Chart(ctx, {
        type: 'bar', // ou 'line'
        data: {
            labels: dadosRecentes.map(f => f.data.split('-').reverse().slice(0,2).join('/')), // Formata DD/MM
            datasets: [{
                label: 'Saldo Final (R$)',
                data: dadosRecentes.map(f => f.saldoFinal),
                backgroundColor: '#10B981',
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Carrega os dados do localStorage
    if (typeof carregarDadosIniciais === "function") carregarDadosIniciais(); 
    
    // Define o mÃ³dulo inicial
    showModule('produtos'); 

    // Garante que o histÃ³rico de fechamentos seja carregado na memÃ³ria
    if (!localStorage.getItem('historicoFechamentos')) {
        localStorage.setItem('historicoFechamentos', JSON.stringify([]));
    }

    // Se vocÃª quiser que o grÃ¡fico tente carregar mesmo em segundo plano:
    if (typeof renderGraficoMensal === "function") {
        renderGraficoMensal();
    }
});



  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c6ac8b01438ba19',t:'MTc2OTg3OTAyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>